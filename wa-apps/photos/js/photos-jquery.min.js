var $jscomp={scope:{}};$jscomp.defineProperty="function"==typeof Object.defineProperties?Object.defineProperty:function(a,c,e){if(e.get||e.set)throw new TypeError("ES3 does not support getters and setters.");a!=Array.prototype&&a!=Object.prototype&&(a[c]=e.value)};$jscomp.getGlobal=function(a){return"undefined"!=typeof window&&window===a?a:"undefined"!=typeof global&&null!=global?global:a};$jscomp.global=$jscomp.getGlobal(this);$jscomp.SYMBOL_PREFIX="jscomp_symbol_";
$jscomp.initSymbol=function(){$jscomp.initSymbol=function(){};$jscomp.global.Symbol||($jscomp.global.Symbol=$jscomp.Symbol)};$jscomp.symbolCounter_=0;$jscomp.Symbol=function(a){return $jscomp.SYMBOL_PREFIX+(a||"")+$jscomp.symbolCounter_++};
$jscomp.initSymbolIterator=function(){$jscomp.initSymbol();var a=$jscomp.global.Symbol.iterator;a||(a=$jscomp.global.Symbol.iterator=$jscomp.global.Symbol("iterator"));"function"!=typeof Array.prototype[a]&&$jscomp.defineProperty(Array.prototype,a,{configurable:!0,writable:!0,value:function(){return $jscomp.arrayIterator(this)}});$jscomp.initSymbolIterator=function(){}};$jscomp.arrayIterator=function(a){var c=0;return $jscomp.iteratorPrototype(function(){return c<a.length?{done:!1,value:a[c++]}:{done:!0}})};
$jscomp.iteratorPrototype=function(a){$jscomp.initSymbolIterator();a={next:a};a[$jscomp.global.Symbol.iterator]=function(){return this};return a};$jscomp.makeIterator=function(a){$jscomp.initSymbolIterator();var c=a[Symbol.iterator];return c?c.call(a):$jscomp.arrayIterator(a)};$jscomp.arrayFromIterator=function(a){for(var c,e=[];!(c=a.next()).done;)e.push(c.value);return e};$jscomp.arrayFromIterable=function(a){return a instanceof Array?a:$jscomp.arrayFromIterator($jscomp.makeIterator(a))};
$jscomp.findInternal=function(a,c,e){a instanceof String&&(a=String(a));for(var g=a.length,h=0;h<g;h++){var b=a[h];if(c.call(e,b,h,a))return{i:h,v:b}}return{i:-1,v:void 0}};$jscomp.polyfill=function(a,c,e,g){if(c){e=$jscomp.global;a=a.split(".");for(g=0;g<a.length-1;g++){var h=a[g];h in e||(e[h]={});e=e[h]}a=a[a.length-1];g=e[a];c=c(g);c!=g&&null!=c&&$jscomp.defineProperty(e,a,{configurable:!0,writable:!0,value:c})}};
$jscomp.polyfill("Array.prototype.find",function(a){return a?a:function(a,e){return $jscomp.findInternal(this,a,e).v}},"es6-impl","es3");$.wa=$.ui?$.extend(!0,$.wa,$.ui):{};
$.wa=$.extend(!0,$.wa,{data:{},content:!1,get:function(a,c){return void 0==a?this.data:this.data[name]||c||null},set:function(a,c){if(void 0==a)return this.data;"object"==typeof a?$.extend(this.data,a):this.data[a]=value;return this.data},encodeHTML:function(a){return a&&(""+a).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")},decodeHTML:function(a){return a.replace(/&amp;/g,"&").replace(/&lt;/g,"<").replace(/&gt;/g,">")},setHash:function(a){a instanceof String||!a.toString||(a=a.toString());
a=a.replace(/\/\//g,"/");a=a.replace(/^.*#/,"");$.browser&&$.browser.safari?parent?parent.window.location=parent.window.location.href.replace(/#.*/,"")+"#"+a:window.location=location.href.replace(/#.*/,"")+"#"+a:!parent||$.browser&&$.browser.msie?location.hash=a:parent.window.location.hash=a;return!0},back:function(a){2<history.length?"number"==typeof a&&parseInt(a)==a?history.go(-a):history.go(-1):$.browser.msie&&0<history.length?history.back():a&&this.setHash(a);return!1},toggleHashParam:function(a){-1==
location.hash.search(a)?this.addToHash(a):this.removeFromHash(a)},addToHash:function(a){var c=location.hash;-1==c.search(a)&&(c+="/"+a+"/");this.setHash(c)},removeFromHash:function(a){var c=location.hash;-1<c.search(a)&&(c=c.replace(a,""));this.setHash(c)},setTitle:function(a){document.title=a},array_search:function(a,c,e){e=!!e;for(var g in c)if(e&&c[g]===a||!e&&c[g]==a)return g;return!1},dialogCreate:function(a,c){c=$.extend({content:'<h1>Loading... <i class="icon16 loading"></i></h1>',buttons:null,
url:null,post:null,small:!1,onload:null,oncancel:null},c);c.content=$(c.content);c.buttons=c.buttons?$(c.buttons):$('<input type="submit" class="button gray" value="'+$_("Cancel")+'">').click(function(){c.oncancel&&c.oncancel.call(e[0]);$.wa.dialogHide()});var e=$("#"+a);0>=e.size()&&(e=$('<div class="dialog" id="'+a+'" style="display: none"><div class="dialog-background"></div><div class="dialog-window"><div class="dialog-content"><div class="dialog-content-indent"></div></div><div class="dialog-buttons"><div class="dialog-buttons-gradient"></div></div></div></div>').appendTo("body"));
e.find(".dialog-buttons-gradient").empty().append(c.buttons);e.find(".dialog-content-indent").empty().append(c.content);e.show();c.small?e.addClass("small"):e.removeClass("small");if(c.url){var g=function(a){e.find(".dialog-content-indent").html(a);$.wa.waCenterDialog(e);c.onload&&c.onload.call(e[0])};c.post?$.post(c.url,c.post,g):$.get(c.url,g)}this.waCenterDialog(e);var h=function(a){if(e.is(":visible"))if(a&&27==a.keyCode)c.oncancel&&"function"==typeof c.oncancel&&c.oncancel.call(e[0]),$.wa.dialogHide();
else $(document).one("keyup",h)};h();$(document).one("hashchange",$.wa.dialogHide);return e},waCenterDialog:function(a){a=$(a);a=a.find(".dialog-window");var c=a.outerWidth(!0),e=a.outerHeight(!0),g=$(window).width(),h=$(window).height();a.css({left:Math.round((g-c)/2/g*100)+"%",top:Math.round((h-e)/2/h*100)+"%"})},dialogHide:function(){$(".dialog").hide();return!1},dropdownsClose:function(){var a=$(".dropdown:not(.disabled)");a.addClass("disabled");setTimeout(function(){a.removeClass("disabled")},
600)},dropdownsCloseEnable:function(){$(document).on("click",".dropdown:not(.disabled)",this.dropdownsClickHandler)},dropdownsCloseDisable:function(){$(document).off("click",".dropdown:not(.disabled)",this.dropdownsClickHandler)},dropdownsClickHandler:function(a){var c=$(this);c.hasClass("no-click-close")||(c.addClass("disabled"),setTimeout(function(){c.removeClass("disabled")},600))},defaultInputValue:function(a,c,e){a instanceof jQuery||(a=$(a));var g=function(){var g=a.val();g&&g!=c||(a.val(c),
a.addClass(e))};g();a.blur(g);a.focus(function(){a.hasClass(e)&&(a.removeClass(e),a.val(""))})},loadFiles:function(a){$.isArray(a)||(a="object"!==typeof a||$.isArray(a)?[].slice.apply(arguments):$.map(a,function(a,c){return a?c:null}));var c=a.map(function(a){return a?"string"!=typeof a?"object"===typeof a&&"function"===typeof a.then?a:null:a.match(/\.css(\?.*)?$/)?($("<link>").appendTo("head").attr({type:"text/css",rel:"stylesheet",href:a}),null):$.ajax({cache:!0,dataType:"script",url:a}):null}).filter(function(a){return!!a});
return $.when.apply($,c)},determineTimezone:function(a,c){var e=!1;$.each(document.cookie.split(/;\s*/g),function(a,b){b=b.split("=",2);if("tz"==b[0])return e=!0,c&&c(b[1]),!1});if(!e){var g={};g[a+"wa-content/js/jstz/jstz.min.js"]=!window.jstz;$.wa.loadFiles(g).then(function(){var a=window.jstz.determine().name();document.cookie="tz="+jstz.determine().name()+"; sameSite=LAX";var b=new Date;b.setTime(b.getTime()+12096E5);document.cookie="oldtz="+a+"; expires="+b.toUTCString()+"; sameSite=LAX";c&&
c(a)})}},util:{formatFileSize:function(a){var c=-1;do a/=1024,c++;while(99<a);return Math.max(a,.01).toFixed(2)+(0<=c?" "+$_("kB MB GB TB PB EB".split(" ")[c]):"")}}});
window.wa_skip_ajax_setup||($.ajaxSetup({cache:!1}),$(document).ajaxError(function(a,c,e,g){if(502===c.status&&"abort"==g||e.url&&0<=e.url.indexOf("background_process")||e.data&&0<=e.data.indexOf("background_process"))console&&console.log&&console.log("Notice: XHR failed on load: "+e.url);else if(200!==c.status&&c.responseText){if(!$.wa.errorHandler||$.wa.errorHandler(c))-1!=c.responseText.indexOf("Exception")?$.wa.dialogCreate("ajax-error",{content:"<div>"+c.responseText+"</div>"}):(document.open("text/html"),
document.write(c.responseText),document.close(),$(window).one("hashchange",function(){window.location.reload()}))}else c.getResponseHeader("wa-session-expired")?window.location.reload():"undefined"!==typeof c.responseText&&-1!=c.responseText.indexOf("Exception")&&$.wa.dialogCreate("ajax-error",{content:"<div>"+c.responseText+"</div>"})}));
window.wa_skip_csrf_prefilter||$.ajaxPrefilter(function(a,c,e){a.crossDomain||"POST"!==(a.type||"").toUpperCase()||(c=document.cookie.match(/(?:^|; )_csrf=([^;]*)/))&&c[1]&&(c=decodeURIComponent(c[1]),a.data||0===a.data||(a.data=""),"string"==typeof a.data?-1==a.data.indexOf("_csrf=")&&(a.data+=(0<a.data.length?"&":"")+"_csrf="+c,e.setRequestHeader("Content-type","application/x-www-form-urlencoded")):"object"==typeof a.data&&(window.FormData&&a.data instanceof window.FormData?"function"==typeof a.data.set?
a.data.set("_csrf",c):a.data.append("_csrf",c):a.data._csrf=c))});Array.prototype.indexOf||(Array.prototype.indexOf=function(a,c){var e=this.length,g=Number(c)||0,g=0>g?Math.ceil(g):Math.floor(g);for(0>g&&(g+=e);g<e;g++)if(g in this&&this[g]===a)return g;return-1});$.wa.locale=$.wa.locale||{};
$_=function(a,c){if(!$||!$.wa||!$.wa.locale)return console.log("JS localization failed: empty $.wa.locale"),"string"===typeof c?c:a;if(c){if(!$.wa.locale[c])return console&&console.log("JS localization failed: "+c),c;if("string"==typeof $.wa.locale[c])return $.wa.locale[c];var e=a%10;return 1==Math.floor(a/10)%10||4<e||0==e?$.wa.locale[c][2]:1==e?$.wa.locale[c][0]:$.wa.locale[c][1]}if($.wa.locale[a])return"string"==typeof $.wa.locale[a]?$.wa.locale[a]:$.wa.locale[a][0];console&&console.log("JS localization failed: "+
a);return a};/*
 (c) 2008-2009 Benjamin Arthur Lupton {@link http://www.balupton.com}
 @license GNU Affero General Public License - {@link http://www.gnu.org/licenses/agpl.html}
 @example Visit {@link http://jquery.com/plugins/project/jquery_history_bal} for more information.


 I would like to take this space to thank the following projects, blogs, articles and people:
 - jQuery {@link http://jquery.com/}
 - jQuery UI History - Klaus Hartl {@link http://www.stilbuero.de/jquery/ui_history/}
 - Really Simple History - Brian Dillard and Brad Neuberg {@link http://code.google.com/p/reallysimplehistory/}
 - jQuery History Plugin - Taku Sano (Mikage Sawatari) {@link http://www.mikage.to/jquery/jquery_history.html}
 - jQuery History Remote Plugin - Klaus Hartl {@link http://stilbuero.de/jquery/history/}
 - Content With Style: Fixing the back button and enabling bookmarking for ajax apps - Mike Stenhouse {@link http://www.contentwithstyle.co.uk/Articles/38/fixing-the-back-button-and-enabling-bookmarking-for-ajax-apps}
 - Bookmarks and Back Buttons {@link http://ajax.howtosetup.info/options-and-efficiencies/bookmarks-and-back-buttons/}
 - Ajax: How to handle bookmarks and back buttons - Brad Neuberg {@link http://dev.aol.com/ajax-handling-bookmarks-and-back-button}

*
**
 CHANGELOG
*
 v1.0.1-final, July 11, 2009
 - Restructured a little bit
 - Documented
 - Cleaned go/request

 v1.0.0-final, June 19, 2009
 - Been stable for over a year now, pushing live.

 v0.1.0-dev, July 24, 2008
 - Initial Release

*/
(function(a){"undefined"===typeof console&&(console="undefined"!==typeof window.console?window.console:{});console.log=console.log||function(){};console.debug=console.debug||console.log;console.warn=console.warn||console.log;console.error=console.error||function(){for(var a=[],e=0;e<arguments.length;e++)a.push(arguments[e]);alert(a.join("\n"))};console.trace=console.trace||console.log;console.group=console.group||console.log;console.groupEnd=console.groupEnd||console.log;console.profile=console.profile||
console.log;console.profileEnd=console.profileEnd||console.log;a.History={options:{debug:!1},state:"",$window:null,$iframe:null,handlers:{generic:[],specific:{}},format:function(a){return a=a.replace(/^.+?#/g,"").replace(/^#?\/?|\/?$/g,"")},getState:function(){return a.History.state},setState:function(c){var e=a.History;c=e.format(c);e.state=c;return e.state},getHash:function(){var c=parent&&!a.browser.msie?parent.window.location.hash:window.location.hash||location.hash;return c=a.History.format(c)},
setHash:function(c){c=a.History.format(c);c=c.replace(/^\/?|\/?(\?)|\/?$/g,"/$1");"undefined"===typeof window.location.hash&&(location.hash=c);a.browser.msie&&8>parseInt(a.browser.version,10)&&(a.History.$iframe.contentWindow.document.open(),a.History.$iframe.contentWindow.document.close())},go:function(c){var e=a.History;c=e.format(c);e.getHash()!==c?e.setHash(c):(e.setState(c),e.trigger());return!0},hashchange:function(c){var e=a.History;e.options.debug&&console.debug("History.hashchange",this,
arguments);var g=e.getHash(),h=e.getState();if(!e.$iframe&&h===g||e.$iframe&&e.hash===e.$iframe.contentWindow.document.location.hash||h===g)return!1;e.setState(g);e.trigger();return!0},bind:function(c,e){var g=a.History;e?("undefined"===typeof g.handlers.specific[c]&&(g.handlers.specific[c]=[]),g.handlers.specific[c].push(e)):g.handlers.generic.push(c);return!0},trigger:function(c){var e=a.History;"undefined"===typeof c&&(c=e.getState());var g,h,b,d;if("undefined"!==typeof e.handlers.specific[c])for(d=
e.handlers.specific[c],g=0,h=d.length;g<h;++g)b=d[g],b(c);d=e.handlers.generic;g=0;for(h=d.length;g<h;++g)b=d[g],b(c);return!0},construct:function(){var c=a.History;a(document).ready(function(){c.domReady()});return!0},configure:function(c){var e=a.History;e.options=a.extend(e.options,c);return!0},domReadied:!1,domReady:function(){var c=a.History;if(!c.domRedied)return c.domRedied=!0,c.$window=a(window),c.$window.bind("hashchange",this.hashchange),setTimeout(c.hashchangeLoader,200),!0},hashchangeLoader:function(){var c=
a.History;if(a.browser.msie&&8<=parseInt(a.browser.version))(e=c.getHash())&&c.$window.trigger("hashchange");else{if(a.browser.msie){c.$iframe=a('<iframe id="jquery-history-iframe" style="display: none;"></$iframe>').prependTo(document.body)[0];c.$iframe.contentWindow.document.open();c.$iframe.contentWindow.document.close();var e=c.getHash();e&&(c.$iframe.contentWindow.document.location.hash=e);e=function(){var a=c.format(c.$iframe.contentWindow.document.location.hash);c.getState()!==a&&c.setHash(c.$iframe.contentWindow.document.location.hash);
a=c.getHash();c.getState()!==a&&c.go(a)}}else e=function(){var a=c.getHash();c.getState()!==a&&c.go(a)};a.browser.msie&&8>parseInt(a.browser.version)?setInterval(e,1500):setInterval(e,200)}return!0}};a.History.construct()})(jQuery);jQuery.JSON={useHasOwn:{}.hasOwnProperty?!0:!1,pad:function(a){return 10>a?"0"+a:a},m:{"\b":"\\b","\t":"\\t","\n":"\\n","\f":"\\f","\r":"\\r",'"':'\\"',"\\":"\\\\"},encodeString:function(a){return/["\\\x00-\x1f]/.test(a)?'"'+a.replace(/([\x00-\x1f\\"])/g,function(a,e){var c=jQuery.JSON.m[e];if(c)return c;c=e.charCodeAt();return"\\u00"+Math.floor(c/16).toString(16)+(c%16).toString(16)})+'"':'"'+a+'"'},encodeArray:function(a){var c=["["],e,g,h=a.length,b;for(g=0;g<h;g+=1)switch(b=a[g],typeof b){case "undefined":case "function":case "unknown":break;
default:e&&c.push(","),c.push(null===b?"null":this.encode(b)),e=!0}c.push("]");return c.join("")},encodeDate:function(a){return'"'+a.getFullYear()+"-"+pad(a.getMonth()+1)+"-"+pad(a.getDate())+"T"+pad(a.getHours())+":"+pad(a.getMinutes())+":"+pad(a.getSeconds())+'"'},encode:function(a){if("undefined"==typeof a||null===a)return"null";if(a instanceof Array)return this.encodeArray(a);if(a instanceof Date)return this.encodeDate(a);if("string"==typeof a)return this.encodeString(a);if("number"==typeof a)return isFinite(a)?
String(a):"null";if("boolean"==typeof a)return String(a);var c=["{"],e,g,h;for(g in a)if(!this.useHasOwn||a.hasOwnProperty(g))switch(h=a[g],typeof h){case "undefined":case "function":case "unknown":break;default:e&&c.push(","),c.push(this.encode(g),":",null===h?"null":this.encode(h)),e=!0}c.push("}");return c.join("")},decode:function(a){return eval("("+a+")")}};(function(a,c){a.store=function(c,g){var e=this;if("string"==typeof c)if(a.store.drivers[c])this.driver=a.store.drivers[c];else throw Error("Unknown driver "+c);else if("object"==typeof c){if(!(a.isFunction(c.init)&&a.isFunction(c.get)&&a.isFunction(c.set)&&a.isFunction(c.del)&&a.isFunction(c.flush)))throw Error("The specified driver does not fulfill the API requirements");this.driver=c}else a.each(a.store.drivers,function(){if(!a.isFunction(this.available)||!this.available())return!0;e.driver=this;
return!1===e.driver.init()?(e.driver=null,!0):!1});g||(g=a.store.serializers);this.serializers={};a.each(g,function(b,c){if(!a.isFunction(this.init))return!0;e.serializers[b]=this;e.serializers[b].init(e.encoders,e.decoders)})};a.extend(a.store.prototype,{get:function(a){a=this.driver.get(a);return this.driver.encodes?a:this.unserialize(a)},set:function(a,c){this.driver.set(a,this.driver.encodes?c:this.serialize(c))},del:function(a){this.driver.del(a)},flush:function(){this.driver.flush()},driver:c,
encoders:[],decoders:[],serialize:function(c){var e=this;a.each(this.encoders,function(){var a=e.serializers[this+""];if(!a||!a.encode)return!0;try{c=a.encode(c)}catch(b){}});return c},unserialize:function(c){var e=this;if(!c)return c;a.each(this.decoders,function(){var a=e.serializers[this+""];if(!a||!a.decode)return!0;c=a.decode(c)});return c}});a.store.drivers={localStorage:{ident:"$.store.drivers.localStorage",scope:"browser",available:function(){try{return!!window.localStorage}catch(e){return!1}},
init:a.noop,get:function(a){return window.localStorage.getItem(a)},set:function(a,c){window.localStorage.setItem(a,c)},del:function(a){window.localStorage.removeItem(a)},flush:function(){window.localStorage.clear()}},userData:{ident:"$.store.drivers.userData",element:null,nodeName:"userdatadriver",scope:"browser",initialized:!1,available:function(){try{return!(!document.documentElement||!document.documentElement.addBehavior)}catch(e){return!1}},init:function(){if(!this.initialized)try{this.element=
document.createElement(this.nodeName),document.documentElement.insertBefore(this.element,document.getElementsByTagName("title")[0]),this.element.addBehavior("#default#userData"),this.initialized=!0}catch(e){return!1}},get:function(a){this.element.load(this.nodeName);return this.element.getAttribute(a)},set:function(a,c){this.element.setAttribute(a,c);this.element.save(this.nodeName)},del:function(a){this.element.removeAttribute(a);this.element.save(this.nodeName)},flush:function(){this.element.expires=
(new Date).toUTCString();this.element.save(this.nodeName)}},windowName:{ident:"$.store.drivers.windowName",scope:"window",cache:{},encodes:!0,available:function(){return!0},init:function(){this.load()},save:function(){window.name=a.store.serializers.json.encode(this.cache)},load:function(){try{this.cache=a.store.serializers.json.decode(window.name+""),"object"!=typeof this.cache&&(this.cache={})}catch(e){this.cache={},window.name="{}"}},get:function(a){return this.cache[a]},set:function(a,c){this.cache[a]=
c;this.save()},del:function(a){try{delete this.cache[a]}catch(g){this.cache[a]=c}this.save()},flush:function(){window.name="{}"}}};a.store.serializers={json:{ident:"$.store.serializers.json",init:function(a,c){a.push("json");c.push("json")},encode:"object"==typeof JSON?JSON.stringify:a.JSON.stringify,decode:"object"==typeof JSON?JSON.parse:a.JSON.parse},xml:{ident:"$.store.serializers.xml",init:function(a,c){a.unshift("xml");c.push("xml")},isXML:function(a){return(a=(a?a.ownerDocument||a:0).documentElement)?
"html"!==a.nodeName.toLowerCase():!1},encode:function(a){if(!a||a._serialized||!this.isXML(a))return a;var c={_serialized:this.ident,value:a};try{return c.value=(new XMLSerializer).serializeToString(a),c}catch(h){try{return c.value=a.xml,c}catch(b){}}return a},decode:function(a){if(!a||!a._serialized||a._serialized!=this.ident)return a;var e="DOMParser"in window&&(new DOMParser).parseFromString;!e&&window.ActiveXObject&&(e=function(a){var b=new ActiveXObject("Microsoft.XMLDOM");b.async="false";b.loadXML(a);
return b});if(!e)return c;a.value=e.call("DOMParser"in window&&new DOMParser||window,a.value,"text/xml");return this.isXML(a.value)?a.value:c}}}})(jQuery);(function(a){function c(a,c){this.path=a;"undefined"!==typeof c&&null!==c?(this.at_2x_path=c,this.perform_check=!1):(this.at_2x_path=a.replace(/\.\w+$/,function(a){return"@2x"+a}),this.perform_check=!0)}function e(e){if(!/@2x\.\w+$/.test(a(e).attr("src"))){this.el=e;this.path=new c(a(e).attr("src"),a(e).attr("data-at2x"));var g=this;this.path.check_2x_variant(function(a){a&&g.swap()})}}a.fn.retina=function(c){if(a.Retina.isRetina())return a.Retina.opts=a.extend(a.Retina.opts,c),this.each(function(){a(this).is("img")&&
new e(this)})};a.Retina=function(){};a.Retina.opts={check_mime_type:!0,force_original_dimensions:!0};a.Retina.isRetina=function(){return 1<window.devicePixelRatio||window.matchMedia&&window.matchMedia("(-webkit-min-device-pixel-ratio: 1.5),(min--moz-device-pixel-ratio: 1.5),(-o-min-device-pixel-ratio: 3/2),(min-resolution: 1.5dppx)").matches?!0:!1};c.confirmed_paths=[];c.prototype.is_external=function(){return!(!this.path.match(/^(https?\:|\/\/)/i)||this.path.match("//"+document.domain+"/"))};c.prototype.check_2x_variant=
function(e){var g,b=this;if(this.is_external()||!this.perform_check&&"undefined"!==typeof this.at_2x_path&&null!==this.at_2x_path||this.at_2x_path in c.confirmed_paths)return e(!0);g=new XMLHttpRequest;g.open("HEAD",this.at_2x_path);g.onreadystatechange=function(){if(4==g.readyState&&200<=g.status&&399>=g.status){if(a.Retina.opts.check_mime_type){var d=g.getResponseHeader("Content-Type");if(null===d||!d.match(/^image/i))return e(!1)}c.confirmed_paths.push(b.at_2x_path);return e(!0)}return e(!1)};
g.send()};a.RetinaImage=e;e.prototype.swap=function(c){function e(){if(b.el.complete){a.Retina.opts.force_original_dimensions&&(b.el.setAttribute("width",b.el.offsetWidth),b.el.setAttribute("height",b.el.offsetHeight));var d=b.el.src;b.el.setAttribute("src",c);a(b.el).one("error",function(){b.el.setAttribute("src",d)})}else setTimeout(e,5)}"undefined"==typeof c&&(c=this.path.at_2x_path);var b=this;e()}})(jQuery);(function(a){var c=[],e=[];a.fn.doAutosize=function(c){var e=a(this).data("minwidth"),b=a(this).data("maxwidth"),d="",f=a(this),g=a("#"+a(this).data("tester_id"));d!==(d=f.val())&&(d=d.replace(/&/g,"&").replace(/\s/g," ").replace(/</g,"<").replace(/>/g,">"),g.html(d),g=g.width(),c=g+c.comfortZone>=e?g+c.comfortZone:e,g=f.width(),(c<g&&c>=e||c>e&&c<b)&&f.width(c))};a.fn.resetAutosize=function(c){var e=a(this).data("minwidth")||c.minInputWidth||a(this).width();c=a(this).data("maxwidth")||c.maxInputWidth||
a(this).closest(".tagsinput").width()-c.inputPadding;var b=a(this),d=a("<tester/>").css({position:"absolute",top:-9999,left:-9999,width:"auto",fontSize:b.css("fontSize"),fontFamily:b.css("fontFamily"),fontWeight:b.css("fontWeight"),letterSpacing:b.css("letterSpacing"),whiteSpace:"nowrap"}),f=a(this).attr("id")+"_autosize_tester";0< !a("#"+f).length&&(d.attr("id",f),d.appendTo("body"));b.data("minwidth",e);b.data("maxwidth",c);b.data("tester_id",f);b.css("width",e)};a.fn.addTag=function(g,h){h=jQuery.extend({focus:!1,
callback:!0},h);this.each(function(){var b=a(this).attr("id"),d=a(this).val().split(c[b]);""==d[0]&&(d=[]);g=jQuery.trim(g);var f;h.unique?(f=a(d).tagExist(g),1==f&&a("#"+b+"_tag").addClass("not_valid")):f=!1;if(""!=g&&1!=f&&(a("<span>").addClass("tag").append(a("<span>").text(g).append("\u00a0\u00a0"),a("<a>",{href:"#",title:"Removing tag",text:"x"}).click(function(){return a("#"+b).removeTag(escape(g))})).insertBefore("#"+b+"_addTag"),d.push(g),a("#"+b+"_tag").val(""),h.focus?a("#"+b+"_tag").focus():
a("#"+b+"_tag").blur(),a.fn.tagsInput.updateTagsField(this,d),h.callback&&e[b]&&e[b].onAddTag&&(f=e[b].onAddTag,f.call(this,g)),e[b]&&e[b].onChange)){var k=d.length;f=e[b].onChange;f.call(this,a(this),d[k-1])}});return!1};a.fn.removeTag=function(g){g=unescape(g);this.each(function(){var h=a(this).attr("id"),b=a(this).val().split(c[h]);a("#"+h+"_tagsinput .tag").remove();str="";for(var d=0;d<b.length;d++)b[d]!=g&&(str=str+c[h]+b[d]);a.fn.tagsInput.importTags(this,str);e[h]&&e[h].onRemoveTag&&e[h].onRemoveTag.call(this,
g)});return!1};a.fn.tagExist=function(c){return 0<=jQuery.inArray(c,a(this))};a.fn.importTags=function(c){id=a(this).attr("id");a("#"+id+"_tagsinput .tag").remove();a.fn.tagsInput.importTags(this,c)};a.fn.tagsInput=function(g){var h=jQuery.extend({interactive:!0,defaultText:"add a tag",minChars:0,width:"300px",height:"100px",autocomplete:{selectFirst:!1},hide:!0,delimiter:",",unique:!0,removeWithBackspace:!0,placeholderColor:"#666666",autosize:!0,comfortZone:20,inputPadding:12},g);this.each(function(){h.hide&&
a(this).hide();var b=a(this).attr("id"),d=jQuery.extend({pid:b,real_input:"#"+b,holder:"#"+b+"_tagsinput",input_wrapper:"#"+b+"_addTag",fake_input:"#"+b+"_tag"},h);c[b]=d.delimiter;if(h.onAddTag||h.onRemoveTag||h.onChange)e[b]=[],e[b].onAddTag=h.onAddTag,e[b].onRemoveTag=h.onRemoveTag,e[b].onChange=h.onChange;var f='<div id="'+b+'_tagsinput" class="tagsinput"><div id="'+b+'_addTag">';h.interactive&&(f=f+'<input id="'+b+'_tag" value="" data-default="'+h.defaultText+'" />');a(f+'</div><div class="tags_clear"></div></div>').insertAfter(this);
a(d.holder).css("width",h.width);a(d.holder).css("height",h.height);""!=a(d.real_input).val()&&a.fn.tagsInput.importTags(a(d.real_input),a(d.real_input).val());if(h.interactive){a(d.fake_input).val(a(d.fake_input).attr("data-default"));a(d.fake_input).css("color",h.placeholderColor);a(d.fake_input).resetAutosize(h);a(d.holder).bind("click",d,function(b){a(b.data.fake_input).focus()});a(d.fake_input).bind("focus",d,function(b){a(b.data.fake_input).val()==a(b.data.fake_input).attr("data-default")&&
a(b.data.fake_input).val("");a(b.data.fake_input).css("color","#000000")});if(void 0!=h.autocomplete_url){autocomplete_options={source:h.autocomplete_url};for(attrname in h.autocomplete)autocomplete_options[attrname]=h.autocomplete[attrname];void 0!==jQuery.Autocompleter?(a(d.fake_input).autocomplete(h.autocomplete_url,h.autocomplete),a(d.fake_input).bind("result",d,function(c,d,e){d&&a("#"+b).addTag(d[0]+"",{focus:!0,unique:h.unique})})):void 0!==jQuery.ui.autocomplete&&(a(d.fake_input).autocomplete(autocomplete_options),
a(d.fake_input).bind("autocompleteselect",d,function(b,c){a(b.data.real_input).addTag(c.item.value,{focus:!0,unique:h.unique});return!1}))}else a(d.fake_input).bind("blur",d,function(b){var c=a(this).attr("data-default");""!=a(b.data.fake_input).val()&&a(b.data.fake_input).val()!=c?b.data.minChars<=a(b.data.fake_input).val().length&&(!b.data.maxChars||b.data.maxChars>=a(b.data.fake_input).val().length)&&a(b.data.real_input).addTag(a(b.data.fake_input).val(),{focus:!0,unique:h.unique}):(a(b.data.fake_input).val(a(b.data.fake_input).attr("data-default")),
a(b.data.fake_input).css("color",h.placeholderColor));return!1});a(d.fake_input).bind("keypress",d,function(b){if(b.which==b.data.delimiter.charCodeAt(0)||13==b.which)return b.preventDefault(),b.data.minChars<=a(b.data.fake_input).val().length&&(!b.data.maxChars||b.data.maxChars>=a(b.data.fake_input).val().length)&&a(b.data.real_input).addTag(a(b.data.fake_input).val(),{focus:!0,unique:h.unique}),a(b.data.fake_input).resetAutosize(h),!1;b.data.autosize&&a(b.data.fake_input).doAutosize(h)});d.removeWithBackspace&&
a(d.fake_input).bind("keydown",function(b){if(8==b.keyCode&&""==a(this).val()){b.preventDefault();b=a(this).closest(".tagsinput").find(".tag:last").text();var c=a(this).attr("id").replace(/_tag$/,"");b=b.replace(/[\s]+x$/,"");a("#"+c).removeTag(escape(b));a(this).trigger("focus")}});a(d.fake_input).blur();d.unique&&a(d.fake_input).keydown(function(b){(8==b.keyCode||String.fromCharCode(b.which).match(/\w+|[\u00e1\u00e9\u00ed\u00f3\u00fa\u00c1\u00c9\u00cd\u00d3\u00da\u00f1\u00d1,\/]+/))&&a(this).removeClass("not_valid")})}return!1});
return this};a.fn.tagsInput.updateTagsField=function(e,h){var b=a(e).attr("id");a(e).val(h.join(c[b]))};a.fn.tagsInput.importTags=function(g,h){a(g).val("");for(var b=a(g).attr("id"),d=h.split(c[b]),f=0;f<d.length;f++)a(g).addTag(d[f],{focus:!1,callback:!1});e[b]&&e[b].onChange&&e[b].onChange.call(g,g,d[f])}})(jQuery);(function(a){a.fn.extend({autocomplete:function(c,e){var g="string"==typeof c;e=a.extend({},a.Autocompleter.defaults,{url:g?c:null,data:g?null:c,delay:g?a.Autocompleter.defaults.delay:10,max:e&&!e.scroll?10:150},e);e.highlight=e.highlight||function(a){return a};e.formatMatch=e.formatMatch||e.formatItem;return this.each(function(){new a.Autocompleter(this,e)})},result:function(a){return this.bind("result",a)},search:function(a){return this.trigger("search",[a])},flushCache:function(){return this.trigger("flushCache")},
setOptions:function(a){return this.trigger("setOptions",[a])},unautocomplete:function(){return this.trigger("unautocomplete")}});a.Autocompleter=function(c,e){function g(){var d=u.selected();if(!d)return!1;var g=d.result;n=g;if(e.multiple){var h=b(p.val());if(1<h.length){var k=e.multipleSeparator.length,l=a(c).selection().start,m,t=0;a.each(h,function(a,b){t+=b.length;if(l<=t)return m=a,!1;t+=k});h[m]=g;g=h.join(e.multipleSeparator)}g+=e.multipleSeparator}p.val(g);f();p.trigger("result",[d.data,d.value]);
return!0}function h(a,b){if(v==m.DEL)u.hide();else{var c=p.val();if(b||c!=n)n=c,c=d(c),c.length>=e.minChars?(p.addClass(e.loadingClass),e.matchCase||(c=c.toLowerCase()),l(c,k,f)):(p.removeClass(e.loadingClass),u.hide())}}function b(b){return b?e.multiple?a.map(b.split(e.multipleSeparator),function(c){return a.trim(b).length?a.trim(c):null}):[a.trim(b)]:[""]}function d(d){if(!e.multiple)return d;var f=b(d);if(1==f.length)return f[0];f=a(c).selection().start;f=f==d.length?b(d):b(d.replace(d.substring(f),
""));return f[f.length-1]}function f(){u.visible();u.hide();clearTimeout(t);p.removeClass(e.loadingClass);e.mustMatch&&p.search(function(a){a||(e.multiple?(a=b(p.val()).slice(0,-1),p.val(a.join(e.multipleSeparator)+(a.length?e.multipleSeparator:""))):(p.val(""),p.trigger("result",null)))})}function k(b,g){if(g&&g.length&&q){p.removeClass(e.loadingClass);u.display(g,b);var h=g[0].value;e.autoFill&&d(p.val()).toLowerCase()==b.toLowerCase()&&v!=m.BACKSPACE&&(p.val(p.val()+h.substring(d(n).length)),a(c).selection(n.length,
n.length+h.length));u.show()}else f()}function l(b,f,g){e.matchCase||(b=b.toLowerCase());var h=r.load(b);if(h&&h.length)f(b,h);else if("string"==typeof e.url&&0<e.url.length){var k={timestamp:+new Date};a.each(e.extraParams,function(a,b){k[a]="function"==typeof b?b():b});a.ajax({mode:"abort",port:"autocomplete"+c.name,dataType:e.dataType,url:e.url,data:a.extend({q:d(b),limit:e.max},k),success:function(c){var d;if(!(d=e.parse&&e.parse(c))){d=[];c=c.split("\n");for(var g=0;g<c.length;g++){var h=a.trim(c[g]);
h&&(h=h.split("|"),d[d.length]={data:h,value:h[0],result:e.formatResult&&e.formatResult(h,h[0])||h[0]})}}r.add(b,d);f(b,d)}})}else u.emptyList(),g(b)}var m={UP:38,DOWN:40,DEL:46,TAB:9,RETURN:13,ESC:27,COMMA:188,PAGEUP:33,PAGEDOWN:34,BACKSPACE:8},p=a(c).attr("autocomplete","off").addClass(e.inputClass),t,n="",r=a.Autocompleter.Cache(e),q=0,v,w={mouseDownOnSelect:!1},u=a.Autocompleter.Select(e,c,g,w),x;a.browser.opera&&a(c.form).bind("submit.autocomplete",function(){if(x)return x=!1});p.bind((a.browser.opera?
"keypress":"keydown")+".autocomplete",function(b){q=1;v=b.keyCode;switch(b.keyCode){case m.UP:b.preventDefault();u.visible()?u.prev():h(0,!0);break;case m.DOWN:b.preventDefault();u.visible()?u.next():h(0,!0);break;case m.PAGEUP:b.preventDefault();u.visible()?u.pageUp():h(0,!0);break;case m.PAGEDOWN:b.preventDefault();u.visible()?u.pageDown():h(0,!0);break;case e.multiple&&","==a.trim(e.multipleSeparator)&&m.COMMA:case m.TAB:case m.RETURN:if(g())return b.preventDefault(),x=!0,!1;break;case m.ESC:u.hide();
break;default:clearTimeout(t),t=setTimeout(h,e.delay)}}).focus(function(){q++}).blur(function(){q=0;w.mouseDownOnSelect||(clearTimeout(t),t=setTimeout(f,200))}).click(function(){1<q++&&!u.visible()&&h(0,!0)}).bind("search",function(){function c(a,b){var c;if(b&&b.length)for(var e=0;e<b.length;e++)if(b[e].result.toLowerCase()==a.toLowerCase()){c=b[e];break}"function"==typeof d?d(c):p.trigger("result",c&&[c.data,c.value])}var d=1<arguments.length?arguments[1]:null;a.each(b(p.val()),function(a,b){l(b,
c,c)})}).bind("flushCache",function(){r.flush()}).bind("setOptions",function(b,c){a.extend(e,c);"data"in c&&r.populate()}).bind("unautocomplete",function(){u.unbind();p.unbind();a(c.form).unbind(".autocomplete")})};a.Autocompleter.defaults={inputClass:"ac_input",resultsClass:"ac_results",loadingClass:"ac_loading",minChars:1,delay:400,matchCase:!1,matchSubset:!0,matchContains:!1,cacheLength:10,max:100,mustMatch:!1,extraParams:{},selectFirst:!0,formatItem:function(a){return a[0]},formatMatch:null,autoFill:!1,
width:0,multiple:!1,multipleSeparator:", ",highlight:function(a,e){return a.replace(new RegExp("(?![^&;]+;)(?!<[^<>]*)("+e.replace(/([\^\$\(\)\[\]\{\}\*\.\+\?\|\\])/gi,"\\$1")+")(?![^<>]*>)(?![^&;]+;)","gi"),"<strong>$1</strong>")},scroll:!0,scrollHeight:180};a.Autocompleter.Cache=function(c){function e(a,b){c.matchCase||(a=a.toLowerCase());var d=a.indexOf(b);"word"==c.matchContains&&(d=a.toLowerCase().search("\\b"+b.toLowerCase()));return-1==d?!1:0==d||c.matchContains}function g(a,e){f>c.cacheLength&&
b();d[a]||f++;d[a]=e}function h(){if(!c.data)return!1;var b={},d=0;c.url||(c.cacheLength=1);b[""]=[];for(var e=0,f=c.data.length;e<f;e++){var h=c.data[e],h="string"==typeof h?[h]:h,n=c.formatMatch(h,e+1,c.data.length);if(!1!==n){var r=n.charAt(0).toLowerCase();b[r]||(b[r]=[]);h={value:n,data:h,result:c.formatResult&&c.formatResult(h)||n};b[r].push(h);d++<c.max&&b[""].push(h)}}a.each(b,function(a,b){c.cacheLength++;g(a,b)})}function b(){d={};f=0}var d={},f=0;setTimeout(h,25);return{flush:b,add:g,populate:h,
load:function(b){if(!c.cacheLength||!f)return null;if(!c.url&&c.matchContains){var g=[],h;for(h in d)if(0<h.length){var k=d[h];a.each(k,function(a,c){e(c.value,b)&&g.push(c)})}return g}if(d[b])return d[b];if(c.matchSubset)for(h=b.length-1;h>=c.minChars;h--)if(k=d[b.substr(0,h)])return g=[],a.each(k,function(a,c){e(c.value,b)&&(g[g.length]=c)}),g;return null}}};a.Autocompleter.Select=function(c,e,g,h){function b(){n&&(r=a("<div/>").hide().addClass(c.resultsClass).css("position","absolute").appendTo(document.body),
q=a("<ul/>").appendTo(r).mouseover(function(b){d(b).nodeName&&"LI"==d(b).nodeName.toUpperCase()&&(m=a("li",q).removeClass(k.ACTIVE).index(d(b)),a(d(b)).addClass(k.ACTIVE))}).click(function(b){a(d(b)).addClass(k.ACTIVE);g();e.focus();return!1}).mousedown(function(){h.mouseDownOnSelect=!0}).mouseup(function(){h.mouseDownOnSelect=!1}),0<c.width&&r.css("width",c.width),n=!1)}function d(a){for(a=a.target;a&&"LI"!=a.tagName;)a=a.parentNode;return a?a:[]}function f(a){l.slice(m,m+1).removeClass(k.ACTIVE);
m+=a;0>m?m=l.size()-1:m>=l.size()&&(m=0);a=l.slice(m,m+1).addClass(k.ACTIVE);if(c.scroll){var b=0;l.slice(0,m).each(function(){b+=this.offsetHeight});b+a[0].offsetHeight-q.scrollTop()>q[0].clientHeight?q.scrollTop(b+a[0].offsetHeight-q.innerHeight()):b<q.scrollTop()&&q.scrollTop(b)}}var k={ACTIVE:"ac_over"},l,m=-1,p,t="",n=!0,r,q;return{display:function(d,e){b();p=d;t=e;q.empty();var f;f=p.length;f=c.max&&c.max<f?c.max:f;for(var g=0;g<f;g++)if(p[g]){var h=c.formatItem(p[g].data,g+1,f,p[g].value,t);
!1!==h&&(h=a("<li/>").html(c.highlight(h,t)).addClass(0==g%2?"ac_even":"ac_odd").appendTo(q)[0],a.data(h,"ac_data",p[g]))}l=q.find("li");c.selectFirst&&(l.slice(0,1).addClass(k.ACTIVE),m=0);a.fn.bgiframe&&q.bgiframe()},next:function(){f(1)},prev:function(){f(-1)},pageUp:function(){0!=m&&0>m-8?f(-m):f(-8)},pageDown:function(){m!=l.size()-1&&m+8>l.size()?f(l.size()-1-m):f(8)},hide:function(){r&&r.hide();l&&l.removeClass(k.ACTIVE);m=-1},visible:function(){return r&&r.is(":visible")},current:function(){return this.visible()&&
(l.filter("."+k.ACTIVE)[0]||c.selectFirst&&l[0])},show:function(){var b=a(e).offset();r.css({width:"string"==typeof c.width||0<c.width?c.width:a(e).width(),top:b.top+e.offsetHeight,left:b.left}).show();if(c.scroll&&(q.scrollTop(0),q.css({maxHeight:c.scrollHeight,overflow:"auto"}),a.browser.msie&&"undefined"===typeof document.body.style.maxHeight)){var d=0;l.each(function(){d+=this.offsetHeight});b=d>c.scrollHeight;q.css("height",b?c.scrollHeight:d);b||l.width(q.width()-parseInt(l.css("padding-left"))-
parseInt(l.css("padding-right")))}},selected:function(){var b=l&&l.filter("."+k.ACTIVE).removeClass(k.ACTIVE);return b&&b.length&&a.data(b[0],"ac_data")},emptyList:function(){q&&q.empty()},unbind:function(){r&&r.remove()}}};a.fn.selection=function(a,e){if(void 0!==a)return this.each(function(){if(this.createTextRange){var b=this.createTextRange();void 0===e||a==e?b.move("character",a):(b.collapse(!0),b.moveStart("character",a),b.moveEnd("character",e));b.select()}else this.setSelectionRange?this.setSelectionRange(a,
e):this.selectionStart&&(this.selectionStart=a,this.selectionEnd=e)});var c=this[0];if(c.createTextRange){var h=document.selection.createRange(),b=c.value,d=h.text.length;h.text="<->";h=c.value.indexOf("<->");c.value=b;this.selection(h,h+d);return{start:h,end:h+d}}if(void 0!==c.selectionStart)return{start:c.selectionStart,end:c.selectionEnd}}})(jQuery);(function(a){a.photos_sidebar={width:200,options:{},init:function(a){var c=this;this.options=a||{};a.width&&(this.width=a.width);c.wa2=a.wa2||!1;c.wa2?(c.$wrapper=a.$wrapper,this.initCollapsibleWa2(),this.initHandlers()):(this.initCollapsible(),this.initHandlers(),this.initView(),setTimeout(function(){c.initFixedSidebar()},1E3))},initFixedSidebar:function(){var c=a(window),e=a("#wa-app"),g=e.find(".p-sidebar-wrapper"),h=e.find(".p-sidebar-block"),b=c.height(),d=h.offset().top,f=!1,k=!1,l=!1,m=0;c.on("scroll",
function(){var a=c.scrollTop(),t=h.outerHeight(),n=e.height(),r=h.offset().top,q=m>a?1:-1,v=a-d,w=h.width(),u=t+parseInt(g.css("padding-top"))+parseInt(g.css("padding-bottom"))>=n;if(n>b&&!u)if(t<b)0<v?((f||!k||l)&&h.removeAttr("style").width(w).addClass("fixed-to-top"),l=!0):h.removeAttr("style").removeClass("fixed-to-bottom").removeClass("fixed-to-top");else if(a<=d){if(f||k||l)h.removeAttr("style").removeClass("fixed-to-bottom").removeClass("fixed-to-top"),f=k=l=!1}else if(a<=r&&r>=d)if(0<q){if(f||
!l||k)h.removeAttr("style").width(w).removeClass("fixed-to-bottom").addClass("fixed-to-top"),f=k=!1,l=!0}else{if(!f||l||k)h.css("top",r-d).removeClass("fixed-to-top").removeClass("fixed-to-bottom"),f=!0,l=k=!1}else if(a+b>=r+t)if(0<q){if(!f||l||k)h.css("top",r-d).removeClass("fixed-to-top").removeClass("fixed-to-bottom"),f=!0,l=k=!1}else{if(f||l||!k)h.removeAttr("style").width(w).removeClass("fixed-to-top").addClass("fixed-to-bottom"),f=l=!1,k=!0}else{if(!f||l||k)h.css("top",r-d).removeClass("fixed-to-top").removeClass("fixed-to-bottom"),
f=!0,l=k=!1}else if(f||l||k)h.removeAttr("style").removeClass("fixed-to-bottom").removeClass("fixed-to-top"),f=l=k=!1;m=a})},initView:function(){var c=a("#p-sidebar"),e=a("#p-sidebar-width-control");e.find("a.arrow").unbind("click").bind("click",function(){var g=c.attr("class"),h=0,b=g.match(/left([\d]{2,3})px/);if(b&&b[1]&&(h=parseInt(b[1]))&&(b=h+(a(this).is(".right")?50:-50),b=Math.max(Math.min(b,400),200),b!=h)){e.css({width:b.toString()+"px"});h=["left"+h+"px","left"+b+"px"];c.attr("class",g.replace(h[0],
h[1]));c.css("width","");var d=a("#p-content");d.length&&(g=d.attr("class"),d.attr("class",g.replace(h[0],h[1])),d.css("margin-left",""));a.photos_sidebar.width=b;a.post("?action=sidebarSaveWidth",{width:b},"json")}return!1})},initCollapsible:function(){a("#p-sidebar").off("click",".collapse-handler").on("click",".collapse-handler",function(){a.photos_sidebar._collapseSidebarSection(this,"toggle")});a("#p-sidebar .collapse-handler").each(function(){a.photos_sidebar._collapseSidebarSection(this,"restore")});
a("#album-list-container").die("uncollapse_section").live("uncollapse_section",function(c,e){e=a(e);var g=a(this).find(">.collapse-handler"),h=e.find(">i.collapse-handler");a.photos_sidebar._collapseSidebarSection(h,"uncollapse");for(h=e.parent().parent();h.length&&h.get(0)!=this;){var b=h.find(">i.collapse-handler");if(!b.length)break;a.photos_sidebar._collapseSidebarSection(b,"uncollapse");h=h.parent().parent()}a.photos_sidebar._collapseSidebarSection(g,"uncollapse")})},initCollapsibleWa2:function(){function c(a,
c){var b="photos/sidebar/collapsed_albums";"section"===c&&(b="photos/sidebar/collapsed_sections");return!!g(b)[a]}function e(a,c){var b=a.data("id"),d=a.hasClass("is-collapsed"),e="photos/sidebar/collapsed_albums";"section"===c&&(e="photos/sidebar/collapsed_sections");var h=g(e);b&&(d?delete h[b]:h[b]=!0);localStorage.setItem(e,JSON.stringify(h));a.toggleClass("is-collapsed")}function g(a){return(a=localStorage.getItem(a))?JSON.parse(a):{}}var h=this.$wrapper.find(".p-sidebar-section");this.$wrapper.find(".js-album-list li").each(function(){var b=
a(this),d=b.data("id"),f=b.find(".caret");f.length&&(f.on("click",function(a){a.preventDefault();b.trigger("collapse_a")}),b.on("collapse_a",function(a){a.preventDefault();e(b,"album")}),d&&c(d,"album")&&b.trigger("collapse_a"))});h.each(function(){var b=a(this),d=b.data("id"),f=b.find(".heading .caret");f.length&&(f.on("click",function(a){a.preventDefault();b.trigger("collapse_s")}),b.on("collapse_s",function(a){a.preventDefault();e(b,"section")}),d&&c(d,"section")&&b.trigger("collapse_s"))})},initHandlers:function(){a("#p-upload-link").on("click",
function(c){c.preventDefault();a.photos.uploadDialog()});a("#album-list-container").off("click",".p-new-album").on("click",".p-new-album",function(){var c=a(this),e=0;c.is("#p-new-album")||(e=parseInt(c.parents("li:first").attr("rel"),10)||0);c=a("#album-create-dialog-acceptor");c.length||(c=a("<div id='album-create-dialog-acceptor'></div>"),a("body").append(c));c.load("?module=dialog&action=createAlbum&parent_id="+e,function(){a.waDialog({$wrapper:a("#album-create-dialog"),onOpen:function(c,h){c.find("input[type=text]").val("");
var b=c.find("form");b.find(".js-privacy-settings-link").on("click",function(){a(window).resize()});b.on("submit",function(c){c.preventDefault();a.post(b.attr("action"),b.serialize(),function(b){"ok"==b.status&&(a.photos.onCreateAlbum(b.data,e),h.close(),b.data.id&&a.photos.goToHash("/album/"+b.data.id))},"json")})}})});return!1})},countSubtree:function(c){var e=c.find(">.count:not(.subtree)"),g=c.find(">.subtree");g.length||(g=e.clone().addClass("subtree").hide(),e.after(g));var h=parseInt(e.text(),
10)||0;c.find("li.static>.count:not(.subtree)").each(function(){var b=parseInt(a(this).text(),10)||0;h+=b});g.hasClass("never-recount")||g.text(h);g.show();e.hide();return h},countItem:function(a){var c=a.find(">.count:not(.subtree)").show();a.find(">.subtree").hide();return parseInt(c.text(),10)||0},_collapseSidebarSection:function(c,e){e||(e="coollapse");c=a(c);if(c.length){var g;g=c.hasClass("darr")||c.hasClass("rarr")?c:c.find(".darr, .rarr");if(g.length){var h=c.parent(),b=h.find(".hierarchical:first");
b.length||(b=h.find(".collapsible-content:first"));b.length||(b=h.find("ul:first"));var d,f=c.attr("id")||c.parent().attr("id"),k=g.hasClass("darr")?"shown":"hidden",l=function(){b.hide();g.removeClass("darr").addClass("rarr");a.photos_sidebar.countSubtree(h);d="hidden"},m=function(){b.show();g.removeClass("rarr").addClass("darr");a.photos_sidebar.countItem(h);d="shown"};switch(e){case "toggle":"shown"==k?l():m();break;case "restore":f&&("hidden"==a.storage.get("photos/collapsible/"+f)?l():m());break;
case "uncollapse":m();break;default:l()}f&&d&&a.storage.set("photos/collapsible/"+f,d)}}}}})(jQuery);(function(a){function c(){var c=a.photos.getAlbum();return c&&c.type===Album.TYPE_STATIC&&!1!==c.edit_rights?!0:!1}function e(){a("#hint-menu-block").hide().children().hide()}a.photos_dragndrop={helper_shift:20,init:function(){this._extendJqueryUIDragAndDrop();this._initDragPhotos();this._initDropPhotos();this._initDragAlbums();this._initDropAlbums()},_initDragPhotos:function(){var c={opacity:.75,zIndex:9999,distance:5,appendTo:"body",cursor:"move",refreshPositions:!0,start:function(b,c){document.ondragstart=
function(){return!1};c.helper.data("scrollTop",a(document).scrollTop());a(document).bind("scroll",a.photos_dragndrop._scrolHelper);a("#album-list-container").addClass("p-drag-active")},stop:function(b,c){document.ondragstart=null;a(document).unbind("scroll",a.photos_dragndrop._scrolHelper);a("#album-list-container").removeClass("p-drag-active");e()},drag:function(b,c){var d=b.originalEvent;c.position.left=d.pageX-a.photos_dragndrop.helper_shift;c.position.top=d.pageY}},h=c.start,b=c.stop;a("img",
a("#photo-list")).liveDraggable(a.extend({},c,{containment:[0,0,a(window).width(),{toString:function(){return a(document).height()}}],helper:function(b){b=a(this).parents("li:first");var c=a("#photo-list li.selected"),d=c.length?c.length:1,e=[b.attr("data-photo-id")],h=!1,g=b.get(0);c.each(function(){this!=g?e.push(a(this).attr("data-photo-id")):h=!0});!h&&c.length&&(b.addClass("selected").find("input:first").trigger("select",!0),++d);b.data("photo_ids",e);return'<div id="helper"><span class="indicator red">'+
d+'</span><i class="icon10 no-bw" style="display:none;"></i></div>'},handle:".p-image",start:function(b,c){h.apply(this,[b,c]);var d=a(this).parents("li:first");1==d.data("photo_ids").length&&d.addClass("selected")},stop:function(c,e){b.apply(this,[c,e]);var d=a(this).parents("li:first");1==d.data("photo_ids").length&&d.removeClass("selected")}}));a("#photo").liveDraggable(a.extend({},c,{containment:"body",start:function(b,c){if(!a(b.target).hasClass("ui-draggable"))return!1},helper:function(){return'<div id="helper"><span class="indicator red">1</span><i class="icon10 no-bw" style="display:none;"></i></div>'}}))},
_initDropPhotos:function(){a("li",a("#photo-list")).liveDroppable({disabled:!1,greedy:!0,tolerance:"pointer",over:function(g,h){if(h.draggable.hasClass("dr"))return!1;if(c())e();else{var b=a.photos.getOption("sort_method");if(b){var d=a("#hint-menu-block").show();d.children().hide();d.find("."+b).show()}}a.photos_dragndrop._activatePhotoListItem.call(this)},out:function(c,e){a.photos_dragndrop._unactivatePhotoListItem.call(this)},drop:function(e,h){var b=c(),d=a.photos.getAlbum(),f=h.draggable.parents("li:first"),
g=a(this);if(f.get(0)==this||g.hasClass("selected"))return a.photos_dragndrop._unactivatePhotoListItem.call(this),!1;var l=a("#photo-list li.selected");l.length||(l=f);a.photos_dragndrop._unactivatePhotoListItem.call(this);a.photos_dragndrop._unactivatePhotoListItem.call(f);if(!b)return!1;var m=parseInt(g.attr("data-photo-id"));g.hasClass("last")?(m=null,g.after(l),g.removeClass("last"),a("#photo-list li:last").addClass("last")):(g.before(l),f.hasClass("last")&&(f.removeClass("last"),a("#photo-list li:last").addClass("last")));
l.trigger("select",!1);var p=[];l.each(function(){p.push(parseInt(a(this).attr("data-photo-id")))});a.post("?module=album&action=photoMove",{photo_id:p,album_id:d.id,before_id:m},function(b){"ok"==b.status&&a.photos.photo_stream_cache.move(p,m)},"json")}})},_initDragAlbums:function(){var c=a("#js-app-sidebar"),e=c.position(),b=c.width(),c=c.height();a("#album-list").find("li.dr").liveDraggable({containment:[e.left,e.top,e.left+b+.25*b,e.top+c],refreshPositions:!0,revert:"invalid",helper:function(){var b=
a(this).clone().addClass("ui-draggable").css({position:"absolute"}).prependTo("#album-list > ul");b.find("a:first").append('<i class="fas fa-times" style="margin-left: 0; margin-right: 0; display:none;"></i>');return b},cursor:"move",cursorAt:{left:5},opacity:.75,zIndex:9999,distance:5,start:function(a,b){document.ondragstart=function(){return!1}},stop:function(){document.ondragstart=null}})},_initDropAlbums:function(){this._initDropBetweenAlbums();this._initDropInsideAlbums()},_initDropBetweenAlbums:function(){a("#album-list").find("li.drag-newposition").liveDroppable({accept:"li.dr",
greedy:!0,tolerance:"pointer",over:function(c,e){if("IMG"==e.draggable.get(0).tagName)return!1;a(this).addClass("active").parent().parent().addClass("drag-active")},out:function(c,e){a(this).removeClass("active").parent().parent().removeClass("drag-active")},deactivate:function(c,e){var b=a(this);(b.is(":animated")||b.hasClass("dragging"))&&b.stop().animate({height:"0px"},300,null,function(){b.removeClass("dragging")});a(this).removeClass("active").parent().parent().removeClass("drag-active")},drop:function(c,
e){if("IMG"==e.draggable.get(0).tagName)return!1;var b=a(this).parent("ul"),d=a(e.draggable),f=d.attr("rel"),h=a(this).prev("li");if(h.length&&h.attr("rel")==f&&!h.hasClass("ui-draggable")||this==d.next().get(0))return!1;var b=b.parent("li").length?b.parent("li").attr("rel"):0,h=a(this).next(),g=null;h.length&&(g=h.attr("rel"));a.post("?module=album&action=move",{id:f,before_id:g,parent_id:b},function(b){var c=a.photos.getAlbum(),d=b.data.album,e=b.data.counters;0>=d.status&&a.photos_dragndrop.privateDescendants(d.id)&&
a.photos.dispatch("album/"+d.id+"/");c&&c.id==d.id&&((b=b.data.frontend_link)&&a("#photo-list-frontend-link").attr("href",b).text(b),d.type==Album.TYPE_DYNAMIC&&a.photos.load("?module=album&action=photos&id="+d.id,a.photos.onLoadPhotoList));if(!a.isEmptyObject(e))for(var h in e)e.hasOwnProperty(h)&&album_list.find("li[rel="+h+"]").find(".count:first").text(e[h])},"json");b=d.parent("ul");f=b.children("li.dr[rel!="+f+"]").length;d.next().insertAfter(a(this));d.insertAfter(a(this));f||(b.parent("li").children("i").remove(),
b.remove())}})},privateDescendants:function(c,e){e="boolean"===typeof e?e:!0;var b=a("#album-list").find("li[rel="+c+"]"),d;d=e?b:a();changed=!1;d.add(b.find("li.dr")).each(function(){var b=a(this).find(">a");if(!b.find("i.lock-bw").length){var c=b.find(".pictures").next();c.length?(changed=!0,c.before('<i class="fas fa-lock"></i>')):b.append('<i class="fas fa-lock"></i>')}});return changed},_initDropInsideAlbums:function(){a("li.dr a",a("#album-list")).liveDroppable({accept:function(a){return a.is("li.dr, img#photo")||
a.closest("li[data-photo-id]").length?!0:!1},tolerance:"custom",greedy:!0,out:function(c,e){a(this).parent().removeClass("drag-newparent");e.helper.find("span").show().end().find("i").hide()},over:function(c,e){var b=a(this).parent(),d=!1;e.draggable=a.photos_dragndrop._fixUiDraggable(e.draggable);if(e.draggable.parents("#photo-list").length||e.draggable.is("#photo"))b.hasClass("static")?e.helper.find("span").show().end().find("i").hide():e.helper.find("span").hide().end().find("i").show(),d=!0;b.addClass("drag-newparent");
if(d)return!1;if(e.draggable.hasClass("static")&&!b.hasClass("static"))return e.helper.find("i.no-bw").show(),!1;e.helper.find("i.no-bw").hide();var f='.dr[rel!="'+a(e.draggable).attr("rel")+'"]',g=a(),h=function(a,b){if(0>=b.length)return a;a=a.add(b.nextUntil(f).filter("li.drag-newposition"));return 0<b.nextAll(f).length?a:h(a,b.parent().closest("li"))},d=b.prevAll(f).first();if(0<d.length)var m=d.find(f),g=0<m.length?h(g,m.last()):h(g,d);else g=g.add(b.prevUntil(f).filter("li.drag-newposition"));
var g=0<b.children("ul").children(f).length?g.add(b.children("ul").children("li.drag-newposition:first")):h(g,b),p=a(".drag-newposition:animated, .drag-newposition.dragging").not(g);p.stop().animate({height:"0px"},300,null,function(){p.removeClass("dragging")});g.stop().animate({height:"10px"},300,null,function(){g.addClass("dragging")})},drop:function(c,e){var b=a(this).parent().removeClass("drag-newparent"),d;e.draggable=a.photos_dragndrop._fixUiDraggable(e.draggable);if(e.draggable.parents("#photo-list").length||
e.draggable.is("#photo")){d=this.href.match(/.*#\/album\/([\d]+)/);if(null===d||!parseInt(d[1],10)){console&&console.log("Link: "+this.href+" is not correct");return}d=parseInt(d[1],10);var g=null;b.hasClass("static")&&(g=e.draggable.is("#photo")?[a.photos.photo_stream_cache.getCurrent().id]:e.draggable.data("photo_ids"));g&&(a.photos.addToAlbums({photo_id:g,album_id:d}),a("#photo-list li.selected").trigger("select",!1));return!1}if(e.draggable.hasClass("static")&&!b.hasClass("static"))return!1;g=
a(e.draggable);if(b.attr("rel")==g.attr("rel"))return!1;b.hasClass("drag-newposition")?d=b.parent("ul"):b.children("ul").length?d=b.children("ul"):(d=a('<ul class="menu dr"><li class="drag-newposition"></li></ul>').appendTo(b),d.find(".drag-newposition").mouseover(),a('<i class="icon16 darr overhanging"></i>').insertBefore(b.children("a")));var h=g.attr("rel"),b=b.attr("rel");if(b==g.parent("ul").parent("li.dr").attr("rel"))return!1;a.post("?module=album&action=move",{id:h,parent_id:b},function(b){var c=
a.photos.getAlbum(),d=b.data.album,e=b.data.counters;0>=d.status&&a.photos_dragndrop.privateDescendants(d.id)&&a.photos.dispatch("album/"+d.id+"/");c&&c.id==d.id&&((b=b.data.frontend_link)&&a("#photo-list-frontend-link").attr("href",b).text(b),d.type==Album.TYPE_DYNAMIC&&a.photos.load("?module=album&action=photos&id="+d.id,a.photos.onLoadPhotoList));d=a("#album-list");if(!a.isEmptyObject(e))for(var g in e)e.hasOwnProperty(g)&&d.find("li[rel="+g+"]").find(".count:first").text(e[g])},"json");var b=
g.parent("ul"),h=b.children("li.dr[rel!="+h+"]").length,l=g.next();g.appendTo(d);l.appendTo(d);h||(b.parent("li").children("i").remove(),b.remove())}})},_scrolHelper:function(c){c=a("#helper");var e=c.data("scrollTop"),b=a(document).scrollTop(),e=e?b-e:50;c.css("top",c.position().top+e+"px");c.data("scrollTop",b)},_dropAnimation:function(c,e){var b=[];c.each(function(){var c=a(this),e=c.offset(),g=c.clone().css({"z-index":10,position:"absolute",top:e.top,left:e.left}).insertAfter(c);c.css({opacity:0});
b.push(c.hide(300).promise());b.push(g.animate({top:e.top,left:e.left},300).promise().done(function(){a(this).remove()}))});a.when.apply(a,b).done(function(){"function"===typeof e&&e()})},_shiftToLeft:function(c){if("left"!==c.data("shifted")){var e=c.find(".p-wrapper");if(!e.length){var b=c.children(),e=a("<div class='p-wrapper' style='position:relative;'></div>").appendTo(c);e.append(b)}e.stop().animate({left:-15},200);c.data("shifted","left")}},_shiftToRight:function(c){if("right"!==c.data("shifted")){var e=
c.find(".p-wrapper");if(!e.length){var b=c.children(),e=a("<div class='p-wrapper' style='position:relative;'></div>").appendTo(c);e.append(b)}e.stop().animate({left:15},200);c.data("shifted","right")}},_shiftAtPlace:function(a){if(a.data("shifted")){var c=a.find(".p-wrapper");if(c.length){var b=c.children();c.stop().css({left:0});a.append(b);c.remove()}a.data("shifted","")}},_bindExtDragActivate:function(c,e){a(document).bind("mousemove.ext_drag_activate",function(b){a.photos_dragndrop._extDragActivate(b,
c,e)})},_unbindExtDragActivate:function(){a(document).unbind("mousemove.ext_drag_activate")},_activatePhotoListItem:function(){var e=a(this),h=c(),b=h?"drag-active":"drag-active-disabled";h&&a.photos_dragndrop._shiftToRight(e);e.hasClass("last")?a.photos_dragndrop._bindExtDragActivate(e,b):e.addClass(b)},_unactivatePhotoListItem:function(e){e=a(this);var g=c(),b=g?"drag-active":"drag-active-disabled",d=b+"-last";e.hasClass("last")&&a.photos_dragndrop._unbindExtDragActivate();e.removeClass(b+" "+d);
g&&a.photos_dragndrop._shiftAtPlace(e)},_extDragActivate:function(c,e,b){var d=b+"-last";if(e.hasClass("last")){var f=c.pageX;c=c.pageY;var g=e.width(),h=e.height(),m=e.position();"template-photo-thumbs"==a.photos.list_template?f>m.left+.5*g&&f<=m.left+g?(e.removeClass(b).addClass(d),a.photos_dragndrop._shiftToLeft(e)):f>m.left&&f<=m.left+.5*g?(e.removeClass(d).addClass(b),a.photos_dragndrop._shiftToRight(e)):a.photos_dragndrop._shiftAtPlace(e):"template-photo-descriptions"==a.photos.list_template&&
(c>m.top+.5*h?e.removeClass(b).addClass(d):c>m.top&&e.removeClass(d).addClass(b));(c<m.top||c>m.top+h||f<m.left||f>m.left+g)&&e.removeClass(b).removeClass(d)}else e.addClass(b)},_fixUiDraggable:function(a){if(a.is("#photo"))return a;"IMG"==a.get(0).tagName&&(a=a.parents("li:first"));return a},_extendJqueryUIDragAndDrop:function(){a.fn.liveDraggable=function(c){this.each(function(b,c){var e=a(this);e.data("init_draggable")&&e.die("mouseover",e.data("init_draggable"))});var b;this.live("mouseover",
b=function(){var e=a(this);e.data("init_draggable")||e.data("init_draggable",b).draggable(c)})};a.fn.liveDroppable=function(c){this.each(function(b,c){var e=a(this);e.data("init_droppable")&&e.die("mouseover",e.data("init_droppable"))});var b=function(){var e=a(this);e.data("init_droppable")||(e.data("init_droppable",b).droppable(c),e.mouseover())};b.call(this);this.die("mouseover",b).live("mouseover",b);this.live("mouseover",b)};var c=a.ui.intersect;a.ui.intersect=function(e,b,d){a(e.element).is("#photo")||
"custom"!=d||(d="pointer");if("custom"!=d)return c.call(a.ui,e,b,d);d=b.offset.left;var f=b.offset.top;e=e.helper.position();return a.ui.isOver(e.top,e.left+a.photos_dragndrop.helper_shift,f,d,b.proportions.height,b.proportions.width)}}}})(jQuery);(function(a){var c=function(a,g){var e=/[^\w\-\.:]/.test(a)?new Function(c.arg+",tmpl","var _e=tmpl.encode"+c.helper+",_s='"+a.replace(c.regexp,c.func)+"';return _s;"):c.cache[a]=c.cache[a]||c(c.load(a));return g?e(g,c):function(a){return e(a,c)}};c.cache={};c.load=function(a){var c=document.getElementById(a),e=/<\\\/(\w+)/g;!c&&console&&console.log("template with id="+a+" not found");return c?("textarea"==c.tagName.toLowerCase()?c.value:document.getElementById(a).innerHTML).replace(e,"</$1"):null};
c.regexp=/([\s'\\])(?![^%]*%\})|(?:\{%(=|#)([\s\S]+?)%\})|(\{%)|(%\})/g;c.func=function(a,c,h,b,d,f){if(c)return{"\n":"\\n","\r":"\\r","\t":"\\t"," ":" "}[a]||"\\"+a;if(h)return"="===h?"'+_e("+b+")+'":"'+("+b+"||'')+'";if(d)return"';";if(f)return"_s+='"};c.encReg=/[<>&"'\x00]/g;c.encMap={"<":"&lt;",">":"&gt;","&":"&amp;",'"':"&quot;","'":"&#39;"};c.encode=function(a){return String(a||"").replace(c.encReg,function(a){return c.encMap[a]||""})};c.arg="o";c.helper=",print=function(s,e){_s+=e&&(s||'')||_e(s);},include=function(s,d){_s+=tmpl(s,d);}";
"function"===typeof define&&define.amd?define(function(){return c}):a.tmpl=c})(this);(function(a){a.fn.inlineEditable=function(c,e){function g(){p(a(this))||a(this).addClass(n.placeholderClass).text(n.placeholder)}function h(){p(a(this))==n.placeholder&&a(this).text("").removeClass(n.placeholderClass)}function b(b){return a(b).val()?!1:(a(this).text(n.placeholder).addClass(n.placeholderClass),!0)}function d(){v="edit";this.id=this.id||(""+Math.random()).slice(2);var b=this.id+"-input",c=a("#"+b);c.length||(q.after(k(b)),c=a("#"+b));l(c,q);n.placeholder&&p(a(this))==n.placeholder&&
h.call(q);n.beforeMakeEditable.call(this,c);w=n.truncate?q.data("real_text"):p(q);c.val(w).show().focus();q.hide();a(n.editLink).hide();if(!t){for(var b=[],e=[],d=0,g=n.makeReadableBy.length;d<g;++d){var m=n.makeReadableBy[d];"blur"==m&&c.blur(function(){"read"!=v&&f.call(this)});"enter"==m&&b.push(13);"esc"==m&&b.push(27)}d=0;for(g=n.updateBy.length;d<g;++d)m=n.updateBy[d],"alt+enter"==m&&e.push({ctrl:!1,alt:!0,shift:!1,key:13}),"ctrl+enter"==m&&e.push({ctrl:!0,alt:!1,shift:!1,key:13}),"ctrl+s"==
m&&e.push({ctrl:!0,alt:!1,shift:!1,key:17});b.length&&function(a){c.keydown(function(b){!~a.indexOf(b.keyCode)||b.ctrlKey||b.altKey||b.shiftKey||"read"!=v&&f.call(this,27==b.keyCode?w:null);if(e.length)for(var c in e){var d=e[c];if(b.keyCode==d.key&&b.ctrlKey==d.ctrl&&b.altKey==d.alt&&b.shiftKey==d.shift){q.trigger("readable");break}}})}(b);q.bind("readable",function(b,c){if("read"!=v){var e=a("#"+(this.id+"-input"));f.call(e,e.val(),c)}});t=!0}}function f(c,e){e="undefined"===typeof e?!1:!0;void 0!=
c&&null!=c?a(this).val(c):c=a(this).val();if(!1!==e||!1!==n.beforeBackReadable.call(q.get(0),this,{changed:c!=w,old_text:w,new_text:c})){v="read";if(!n.placeholder||!b.call(q,this))if(n.allowEmpty||c){if(n.truncate)q.data("real_text",c),q.text(c.length<n.truncate-3?c:c.substr(0,n.truncate-3)+"...");else{var d=q,f=c;n.html?d.html(f):d.text(f)}c||g.call(this)}q.show();a(this).hide();a(n.editLink).show();!1===e&&n.afterBackReadable.call(q.get(0),this,{changed:c!=w,old_text:w})}}function k(a){switch(n.inputType){case "textarea":return'<textarea id="'+
a+'" style="display:none;"></textarea>';default:return'<input type="text" id="'+a+'" style="display:none;">'}}function l(a,b){var c=n.size.height||b.height(),e=n.size.width||1.5*b.width(),c=n.minSize.height&&c<n.minSize.height?n.minSize.height:c,e=n.minSize.width&&e<n.minSize.width?n.minSize.width:e,c=n.maxSize.height&&c>n.maxSize.height?n.maxSize.height:c,e=n.maxSize.width&&e>n.maxSize.width?n.maxSize.width:e;a.height(c);a.width(e)}function m(a){return function(){return a}}function p(a){return n.html?
a.html():a.text()}var t=!1;if("string"==typeof c){if("setOption"==c){var n=this.data("inlineEditableSettings")||{};a.extend(!0,n,e);"undefined"!==typeof e.hold&&"function"!==typeof e.hold&&(n.hold=m(n.hold));this.data("inlineEditableSettings",n)}return this}var r=this.data("inlineEditableSettings");this.data("inlineEditableSettings",a.extend({inputType:"text",size:{height:null,width:null},minSize:{height:null,width:null},maxSize:{height:null,width:null},editLink:null,editOnItself:!0,placeholder:null,
makeReadableBy:["blur","enter","esc"],updateBy:["ctrl+enter","alt+enter"],beforeBackReadable:function(){},afterBackReadable:function(){},beforeMakeEditable:function(){},placeholderClass:"hint",truncate:!1,hold:!1,html:!1,allowEmpty:!1},r,c||{}));var n=this.data("inlineEditableSettings"),q=this,v="read",w="";"function"!==typeof n.hold&&(n.hold=m(n.hold));(function(){if(!this.data("inited")){n.truncate&&"boolean"==typeof n.truncate&&(n.truncate=255);if(n.truncate){var b=n.placeholder&&n.placeholder===
this.text()?"":this.text();this.data("real_text",b);this.text(b.length<n.truncate-3?b:b.substr(0,n.truncate-3)+"...")}n.placeholder&&g.call(this);n.editLink&&a(n.editLink).click(function(){n.hold.call(q)||"edit"!=v&&d.call(q.get(0))});n.editOnItself&&this.click(function(){n.hold.call(q)||"edit"!=v&&d.call(this)});this.bind("editable",function(){n.hold.call(q)||"edit"!=v&&d.call(this)});this.bind("placeholder",function(b,c){c&&n.placeholder&&g.call(this);c||a(this).removeClass(n.placeholderClass)});
this.data("inited",!0)}}).call(this);return this}})(jQuery);(function(a){a.fn.activeMenu=function(c,e,g){if("string"==typeof c){if("disable"==c||"enable"==c)return a.isArray(e)||(e=[e]),this.find("li").each(function(){var b=a(this);~e.indexOf(b.attr("data-action"))&&("disable"==c?b.hide():b.show())}),this;if("setOption"==c){var h=this.data("activeMenuSettings");if(!h)return;if("string"===typeof e){var b={};b[e]=g;e=b}a.extend(h,e);return this}}if("string"==typeof c&&"fire"==c){h=this.data("activeMenuSettings");if(!h)return;h["on"+c.substr(0,1).toUpperCase()+
c.substr(1)].call(this);return this}this.data("activeMenuSettings",a.extend({beforeAnyAction:function(){},defaultAction:function(){},onInit:function(){},onFire:function(){}},c||{}));if(h=this.data("activeMenuSettings"))return function(){var b=this;b.data("inited")||(b.bind("click.photos-active-menu",function(c){for(var e=c.target,d=b.get(0);"LI"!=e.tagName;){if(e==d)return;e=a(e).parent().get(0)}for(var e=a(e),d=e.attr("data-action")||"default",d=d.split("-"),f=1;f<d.length;f++)d[f]=d[f][0].toUpperCase()+
d[f].slice(1);d=d.join("");d+="Action";h[d]&&"function"==typeof h[d]||(d="defaultAction");if(!1!==h.beforeAnyAction(e.attr("data-action")))h[d](e,c);c.preventDefault()}),h.onInit(b),b.data("inited",!0))}.call(this),this}})(jQuery);(function(a){a.fn.rateWidget=function(c,e,g){function h(b){var c=0;this.find("svg").removeClass("fa-star-half-alt").attr("data-prefix","far").each(function(){if(c==b)return!1;c++;c>b?.5==c-b&&a(this).attr("data-prefix","fas").addClass("fa-star-half-alt"):a(this).attr("data-prefix","fas")});this.attr("data-rate",b)}function b(a){return function(){return a}}if("string"===typeof c){if("getOption"===c&&"rate"===e)return parseInt(this.attr("data-rate"),10);"setOption"===c&&("rate"===e&&(e=parseFloat(g)||
0,h.call(this,Math.round(2*e)/2),e={rate:g}),"object"===typeof e&&e&&(g=this.data("rateWidgetSettings")||{},a.extend(g,e),"undefined"!==typeof e.hold&&"function"!==typeof e.hold&&(g.hold=b(g.hold))));return this}this.data("rateWidgetSettings",a.extend({onUpdate:function(){},rate:null,hold:!1,withClearAction:!0,alwaysUpdate:!1},c||{}));var d=this.data("rateWidgetSettings"),f=this;"function"!==typeof d.hold&&(d.hold=b(d.hold));(function(){if(!this.data("inited")){null!=d.rate&&f.attr("data-rate",d.rate);
f.find("svg:lt("+f.attr("data-rate")+")").attr("data-prefix","fas");f.mouseover(function(b){d.hold.call(f)||(b=b.target,"svg"!==b.tagName&&"path"!==b.tagName)||(b=a(b),b.prevAll().removeClass("fa-star-half-alt").attr("data-prefix","fas").end().removeClass("fa-star-half-alt").attr("data-prefix","fas"),b.nextAll().removeClass("fa-star-half-alt").attr("data-prefix","far"))}).mouseleave(function(){d.hold.call(f)||h.call(f,f.attr("data-rate"))});f.on("click","svg",function(b){if(!d.hold.call(f)){var c=
f.attr("data-rate"),e=a(this).attr("data-rate-value");f.find("svg").removeClass("fa-star-half-alt").attr("data-prefix","far").each(function(){a(this).attr("data-prefix","fas");if(a(this).attr("data-rate-value")==e){if(d.alwaysUpdate||c!=e)f.attr("data-rate",e),d.onUpdate(e);return!1}})}});if(d.withClearAction){var b="clear-"+a(this).attr("id"),c=a("#"+b);c.length||(f.after('<a href="javascript:void(0);" class="p-rate-clear" id="'+b+'" style="display:none;">'+$_("clear")+"</a>"),c=a("#"+b));c.on("click",
function(a){a.preventDefault();if(!d.hold.call(f)&&(a=f.attr("data-rate"),h.call(f,0),0!=a))d.onUpdate(0)});var e;f.parent().mousemove(function(){d.hold.call(f)||(e&&clearTimeout(e),c.show(0))}).mouseleave(function(){e=setTimeout(function(){d.hold.call(f)||c.hide(0)},150)})}this.data("inited",!0)}}).call(this);return this}})(jQuery);var PhotoStream=function(){var a=function(a){this._options=a||{};this._onClear=this._options.onClear||function(){};this._photo_stream=[]};$.extend(a.prototype,{getById:function(a){for(var c=0,g=this._photo_stream[0],h=this._photo_stream.length;c<h;g=this._photo_stream[++c])if(g&&g.id==a)return g;return null},updateById:function(a,e,g){if(a=this.getById(a))return $.extend(a,e),a;g&&this._photo_stream.push(e);return e},deleteById:function(a){$.isArray(a)||(a=[a]);var c=a,g=0,h=c.length;for(a=c[0];g<
h;a=c[++g])(a=this.getById(a))&&a.index&&delete this._photo_stream[a.index];var c=[],b=0,g=0,h=this._photo_stream.length;for(a=this._photo_stream[0];g<h;a=this._photo_stream[++g])a&&(a.index=b++,c.push(a));this._photo_stream=c;return this},replace:function(a,e){var c=a.index;this._photo_stream[c]=e;e.index=c;return this},push:function(a){this._photo_stream.push(a);a.index=this._photo_stream.length-1;return this},getNext:function(a){a=a||this.current;"object"!=typeof a&&(a=this.getById(a));if(!a)return null;
a=a.index+1;return this._photo_stream[a]?this._photo_stream[a]:null},getPrev:function(a){a=a||this.current;"object"!=typeof a&&(a=this.getById(a));if(!a)return null;a=a.index-1;return this._photo_stream[a]?this._photo_stream[a]:null},setCurrent:function(a){if(!a.index&&(a=this.getById(a.id),!a||"number"!==typeof a.index&&!a.index))throw Error("This photo is not in stream");this.current=a;return this},setCurrentById:function(a){a=this.getById(a);"object"===typeof a&&a&&this.setCurrent(a);return this},
getCurrent:function(){return this.current},getCurrentId:function(){return"object"===typeof this.current&&this.current?this.current.id:null},set:function(a){this._photo_stream=[];this.append(a);this.isEmpty()||this.setCurrent(this.getFirst());return this},append:function(a){for(var c=0,g=a[c],h=this._photo_stream.length,b=a.length;c<b;g=a[++c],++h)g.index=h,this._photo_stream.push(g);return this},prepend:function(a){var c=this._photo_stream||[];this._photo_stream=[];for(var g=0,h=a[g],b=a.length;g<
b;h=a[++g])h.index=g,this._photo_stream.push(h);this.append(c);return this},clear:function(){this._photo_stream=[];this._onClear();return this},length:function(){return this._photo_stream.length},getAll:function(){return this._photo_stream},getFirst:function(){return this._photo_stream[0]},getLast:function(){return this._photo_stream[this._photo_stream.length-1]},isFirst:function(a){return a&&0==a.index},isLast:function(a){return a&&a.index==this._photo_stream.length-1},isEmpty:function(){return!this._photo_stream.length},
getCurrentIndex:function(){return this.current.index},slice:function(a,e){return this._photo_stream.slice(a,e)},move:function(a,e){var c=[],h,b=this._photo_stream;if($.isArray(a))for(var d=0,f=a.length;d<f;++d)h=this.getById(a[d]),delete b[h.index],c.push(h);else h=this.getById(a),delete b[h.index],c.push(h);if(c.length)for(h="undefined"===typeof e||null===e?this._photo_stream.length:(h=this.getById(e))?h.index:0,Array.prototype.splice.apply(b,[h,0].concat(c)),this.clear(),d=c=0,f=b.length;d<f;++d)h=
b[d],"object"===typeof h&&h&&(h.index=c++,this._photo_stream.push(h))}});return a}();Date.parseISO=function(a){var c=Date.parse(a);if(!isNaN(c))return c;a=a.match(/([0-9]{4})-([0-9]{2})-([0-9]{2}) ([0-9]{2}):([0-9]{2}):([0-9]{2})/);c=new Date(a[1],0,1);a[2]&&c.setMonth(a[2]-1);a[3]&&c.setDate(a[3]);a[4]&&c.setHours(a[4]);a[5]&&c.setMinutes(a[5]);a[6]&&c.setSeconds(a[6]);return+c};
function replaceImg(a,c,e,g){g=g||a.attr("id")||(""+Math.random()).slice(2);replaceImg.loading_map=replaceImg.loading_map||{};replaceImg.loading_map[g]=c;a.unbind("load");null===e?a.attr("src",c):$("<img>").attr("src",c).load(function(){setTimeout(function(){replaceImg.loading_map[g]==c&&(a.attr("src",c),"function"==typeof e&&e.call(a));$(this).remove()},100)});return g}
String.prototype.truncate=function(a,c){var e="";if("undefined"===typeof c||c)e=this.replace(/<\/?[\s\S]+?\/?>/g,"");e.length>a-3&&3<a&&(e=e.substr(0,a-3)+"...");return e};function parseSize(a){var c="unknown";a=(""+a).split("x");var e=a[0]&&0!=a[0]?a[0]:null,g=a[1]&&0!=a[1]?a[1]:null;1==a.length?(c="max",g=e):e==g?c="crop":e&&g?c="rectangle":null===e?c="height":null===g&&(c="width");return{type:c,width:e,height:g}}
function getRealSizesOfThumb(a,c){var e=parseInt(a.width,10),g=parseInt(a.height,10),h=e/g,b=g/e,d;if(isNaN(h)||isNaN(b))return null;d="object"!==typeof c?parseSize(c):c;var f=d.width,k=d.height;switch(d.type){case "max":e>g?(h=f,b*=h):(b=f,h*=b);break;case "crop":h=b=f;break;case "rectangle":h=f;b=k;break;case "width":h=f;b*=h;break;case "height":b=k;h*=b;break;default:h=b=null}h=Math.round(h);b=Math.round(b);return e<h&&g<b?{width:a.width,height:a.height}:{width:h,height:b}};(function(a){a.fn.photoStreamSlider=function(c){var e=a.extend({duration:200},c||{}),g=this;(function(){function c(f){function h(){c.execution=!1;var a="on"+m.charAt(0).toUpperCase()+m.slice(1),a=e[a];"function"==typeof a&&a.call(g);a=f.fn;"function"==typeof a&&a.call(g)}"string"==typeof f&&(f={direction:f,animate:!0});var m=f.direction||"forward",p=f.steps||d.length;if(!c.execution){c.execution=!0;var n=d.filter(":first").outerWidth()*p,r=d.length;if("forward"==m){var q=d.filter(":last").nextAll(":lt("+
p+")"),p=q.length,q=q.filter(":last");p&&(d.removeClass("visible"),q.prevAll(":lt("+(r-1)+")").addClass("visible"),q.addClass("visible"))}else q=d.filter(":first").prevAll(":lt("+p+")"),p=q.length,q=q.filter(":last"),p&&(d.removeClass("visible"),q.nextAll(":lt("+(r-1)+")").addClass("visible").show(),q.addClass("visible"));d=a("li.visible",b);r=b.position().left;"forward"==m?(p=l-k-t,r-=n,r=r>-p?r:-p):(r+=n,r=r<t?r:t);f.animate?b.animate({left:r},e.duration,h):(b.css({left:r}),h())}}var b=g.find(e.photoStream),
d=a("li.visible",b),f=a("li",b),k=d.filter(":first").outerWidth()*d.length,l=f.filter(":first").outerWidth()*f.length,m=f.filter(":first").outerHeight();b.parent().css({overflow:"hidden",height:m,position:"relative",padding:"4px 0",margin:0,width:k});for(var m=b.find("li:first"),p=d.filter(":first"),t=(p.outerWidth()-p.width())/2,n=0,r=m.outerWidth(),p=p.get(0);m.length&&m.get(0)!=p;)n+=r,m=m.next();b.css({position:"absolute",left:-(n-t),width:l});a(e.forwardLink).click(function(){c("forward");return!1});
a(e.backwardLink).click(function(){c("backward");return!1});g.bind("append prepend",function(c,e){if("append"==c.type){for(var d=b.find("li:last"),h=a();d.hasClass("dummy");)h=h.add(d),d=d.prev("li");h.remove();b.append(e)}else{var d=a("<div></div>").html(e),h=d.find("li"),k=h.length*r;d.remove();for(var d=b.find("li:first"),m=a();d.hasClass("dummy");)m=m.add(d),d=d.next("li");m.remove();b.prepend(h)}f=b.find("li");l=f.filter(":first").outerWidth()*f.length;b.css("width",l);"prepend"==c.type&&(b.is(":animated")&&
b.stop(!1,!0),b.css("left",parseInt(b.css("left"))-k));b.find("li.selected").hasClass("visible")&&g.trigger("home",[null,!1])});g.bind("forward backward",function(a,e){c({direction:a.type,steps:e.steps,animate:"undefined"!==typeof e.animate?e.animate:!0,fn:e.fn});var d=b.find("li.selected"),f="forward"==a.type?d.next("li:not(.dummy)"):d.prev("li:not(.dummy)");f.length&&(d.removeClass("selected"),f.addClass("selected"))});g.bind("home",function(b,e,f){b=parseInt(d.length/2);b=d.filter(":eq("+b+")");
var g=b.nextAll(".selected:first"),h=b.prevAll(".selected:first"),k=0,l="";"function"!==typeof e&&(f=e);f="undefined"!==typeof f?f:!0;g.length?(l="forward",b.nextAll().each(function(){++k;if(a(this).hasClass("selected"))return!1})):h.length&&(l="backward",b.prevAll().each(function(){++k;if(a(this).hasClass("selected"))return!1}));l&&k?c({direction:l,steps:k,fn:e,animate:f}):"function"==typeof e&&e();return!1})})()}})(jQuery);(function(a){a.storage=new a.store;a.photos={namespace:".photos",load_from_hash:0,hash:"",raw_hash:"",options:{},shift_next:!1,anchor:"",album:null,total_count:null,photos_per_page:null,list_template:"template-photo-thumbs",photo_list_string:{},init:function(c){"undefined"!=typeof a.History&&(a.History.bind(function(){a.photos.dispatch()}),a.History.unbind=function(c,g){g?a.History.handlers.specific[c]&&a.each(a.History.handlers.specific[c],function(e,b){if(b===g)return a.History.handlers.specific[c].splice(e,
1),!1}):(g=c,a.each(a.History.handlers.generic,function(c,b){if(b===g)return a.History.handlers.generic.splice(c,1),!1}))},a.History.one=function(c,g){g||(g=c,c=null);var e=function(){g.call(this);a.History.unbind.apply(a.History,c?[c,e]:[e])};a.History.bind.apply(a.History,c?[c,e]:[e])});a.wa.errorHandler=function(c){a.storage.del("photos/hash");return 403===c.status?(a("#content").html('<div class="content left'+a.photos_sidebar.width+'px"><div class="block double-padded">'+c.responseText+"</div></div>"),
!1):a.photos.load_from_hash?(a.wa.setHash("#/"),!1):!0};this.options=c;(c=window.location.hash||a.storage.get("photos/hash"))&&c!=window.location.hash?(this.load_from_hash=2,a.wa.setHash("#/"+c)):this.dispatch();a(document).on("close",function(c){a(c.target).hide()})},dispatch:function(c){if(a.photos.ignore_dispatch)a.photos.ignore_dispatch--;else if(a.photos.hash="",void 0==c&&(c=window.location.hash),c=c.replace(/^[^#]*#\/*/,""),a.photos.raw_hash=c)if(c=c.split("/"),c[0]){for(var e="",g=c.length,
h=0;h<c.length;h++){var b=c[h];if(2>h)if(0===h)e=b;else if("tag"==e||"search"==e||"plugins"==e||"pages"==e||"app"==e){g=h;break}else if(parseInt(b,10)!=b&&-1==b.indexOf("="))e+=b.substr(0,1).toUpperCase()+b.substr(1);else{g=h;break}else{g=h;break}}g=c.slice(g);a.photos.hash="/"+c.slice(0,2).join("/");~a.photos.hash.indexOf("photo")&&(a.photos.hash="");this.beforeAnyAction(e,g);this[e+"Action"]?(this.load_from_hash&&this.load_from_hash--,this[e+"Action"].apply(this,g),a.storage.set("photos/hash",a.photos.hash)):
(a.storage.del("photos/hash"),console&&console.log("Invalid action name:",e+"Action"))}else this.beforeAnyAction(),this.defaultAction();else this.beforeAnyAction(),this.defaultAction()},ignore_dispatch:0,forceHash:function(c){c!=window.location.hash&&(a.photos.ignore_dispatch=1,window.location.hash=c)},menu:{stack:{list:[],photo:[]},extend_stack:{list:[],photo:[]},register:function(a,e,g){this.stack[a]&&this.stack[a].push(new ToolbarMenu(e,g))},get:function(c,e){if(this.stack[c]&&a.isArray(this.stack[c]))for(var g=
0;g<this.stack[c].length;g++)if(this.stack[c][g].is(e))return this.stack[c][g];return null},init:function(a){var c;if(this.stack[a]){for(;c=this.extend_stack[a].shift();)for(var g=0;g<this.stack[a].length;g++)if(this.stack[a][g].is(c.selector)){for(var h in c.actions)this.stack[a][g].setAction(h,c.actions[h]);break}for(g=0;g<this.stack[a].length;g++)this.stack[a][g].init()}},enable:function(a,e,g){e=e||"*";if(this.stack[a])for(var c=0;c<this.stack[a].length;c++){var b=this.stack[a][c];e&&!b.is(e)||
b.enable(g)}},disable:function(a,e,g){e=e||"*";if(this.stack[a])for(var c=0;c<this.stack[a].length;c++){var b=this.stack[a][c];e&&!b.is(e)||b.disable(g)}},extend:function(a,e,g){this.stack[a]&&this.extend_stack[a].push({selector:e,actions:g});return this}},setOption:function(a,e){this.options[a]=e},getOption:function(a){return this.options[a]},beforeAnyAction:function(){},initClearance:function(){a.photos.toggleFullScreen();a.photos.highlightSidebarItem();a.photos.hotkey_manager.unset();a.photos.unsetLazyLoad();
a.photos.photo_stream_cache.clear();a.photos.photo_stack_cache.clear();delete a.photos.photo_stream_cache.hash},defaultAction:function(){window.location.hash||!a("#album-list ul li.dr").length?(a.storage.set("photos/hash","photos/"),this.photosAction()):(a.storage.set("photos/hash","albums/"),this.albumsAction())},photosAction:function(){a.photos.loadDispatch(arguments,function(){a.photos.load("?module=photo&action=list",a.photos.onLoadPhotoList)})},albumsAction:function(){a.photos.loadDispatch(arguments,
function(){a.photos.load("?action=albums")})},albumAction:function(c){a.photos.loadDispatch(arguments,function(){a.photos.load("?module=album&action=photos&id="+c,a.photos.onLoadPhotoList)})},searchAction:function(c){a.photos.loadDispatch(arguments,function(){a.photos.load("?module=search&action=photos",{q:c},a.photos.onLoadPhotoList)})},tagAction:function(c){a.photos.loadDispatch(arguments,function(){a.photos.load("?module=tag&action=photos&tag="+c,a.photos.onLoadPhotoList)})},appAction:function(c){a.photos.loadDispatch(arguments,
function(){a.photos.load("?module=photo&action=list&app_id="+c,a.photos.onLoadPhotoList)})},settingsAction:function(){a.photos.initClearance();a.photos.load("?module=settings",a.photos.onLoadSettings)},pagesAction:function(c){a("#wa-page-container").length?waLoadPage(c):(a.photos.initClearance(),a.photos.load("?module=pages",a.photos.onLoadPages,""))},designAction:function(c){a.photos.initClearance();c?a("#wa-design-container").length?(a.photos.setTitle($_("Themes")),a.photos.scrollTop(),waDesignLoad()):
a.photos.load("?module=design",function(){waDesignLoad(c);a.photos.setTitle($_("Themes"));a.photos.scrollTop()}):a.photos.load("?module=design",function(){waDesignLoad("");a.photos.setTitle($_("Design"));a.photos.scrollTop()})},designThemesAction:function(c){a.photos.initClearance();a("#wa-design-container").length?(a.photos.setTitle($_("Themes")),a.photos.scrollTop(),waDesignLoad()):a.photos.load("?module=design",function(){waDesignLoad();a.photos.setTitle($_("Themes"));a.photos.scrollTop()},'<div class="content left'+
a.photos_sidebar.width+'px"></div>')},pluginsAction:function(c){a.photos.initClearance();a("#js-app-sidebar li.selected").removeClass("selected");a("#js-app-sidebar #sidebar-plugins").addClass("selected");a("#wa-plugins-container").length?a.plugins.dispatch("#/plugins/"+c):a.photos.load("?module=plugins")},photoAction:function(c){a.photos.loadPhoto(c)},loadDispatch:function(c,e){for(var g=Array.prototype.slice.call(c,1),h=0;h<g.length;h++)if("photo"==g[h]&&h<g.length-1){this.loadPhoto(g[h+1]);return}"function"==
typeof e&&e(c[0]);a.photos.initClearance()},onLoadSettings:function(){a.photos.setTitle($_("Settings"));a.photos.scrollTop()},onLoadPlugins:function e(g){a.photos.setTitle($_("Plugins"));a("#plugins-settings-form").submit(function(){a("#plugins-settings-form-status").fadeIn(400);a("#plugins-settings-iframe").one("load",function(){var h=a.parseJSON(a(this).contents().find("body").html());a("#plugins-settings-form-status").fadeOut(200,function(){"ok"==h.status?a.photos.loadPluginSettings(g,e):(a("#plugins-settings-form-status").html(h.errors?
h.errors:h).css("color","red"),a("#plugins-settings-form-status").fadeIn("slow"))})})});a.photos.scrollTop()},onLoadPages:function(){a.photos.setTitle($_("Pages"));a.photos.scrollTop()},renderPhotoList:function(){var e=a("#photo-list");e.empty();a.photos.renderPhotoListChunk(e,0);a.photos.photo_stream_cache.length()&&(!a.photos.total_count||a.photos.total_count>a.photos.photo_stream_cache.length())&&a.photos.setLazyLoad()},renderPhotoListChunk:function(e,g,h,b){var d=a.photos.options.photo_list_render_chunk||
10,f=a.photos.photo_stream_cache.length();h=h||{};h.hide_name||(h.hide_name=a.storage.get("photos/list/hide_name",!1));d=a.photos.photo_stream_cache.slice(g,g+=d);d={photos:d,hash:a.photos.hash,last_login_time:a.photos.options.last_login_time,options:h,selected:!!a("#selector-menu").find("[data-action=select-photos]").data("checked"),view:(a.photos.list_template||"").replace("template-photo-","")};e.append(tmpl(a.photos.list_template,d));a("#content").trigger("photos_list_chunk_render",[d]);if(g<
f)setTimeout(function(){a.photos.renderPhotoListChunk(e,g,h,b)},100);else if("function"==typeof b&&b(),d=h.string||a.photos.photo_list_string||!1)a(".lazyloading-wrapper").html(tmpl("template-photo-counter",{count:f,total_count:a.photos.total_count,string:d})),a.photos.photo_list_string=d},selectPhotoListView:function(e){e=e.replace(/-view$/,"");a.photos.list_template="template-photo-"+e;var g=a.photos.getAlbum();g&&("thumbs"==e?a.storage.del("photos/list/view/"+g.id):a.storage.set("photos/list/view/"+
g.id,e));a.photos.menu.enable("list","."+e+"-view-menu");a.photos.menu.disable("list",":not(."+e+"-view-menu)");g=a("#photo-list");g.removeClass(g.attr("class"));switch(e){case "thumbs":g.addClass("thumbs li300px");break;case "descriptions":g.addClass("p-descriptions")}a("#js-photos-view-toggle .selected").removeClass("selected");a('#js-photos-view-toggle [data-action="'+e+'-view"]').addClass("selected")},onLoadPhotoList:function(){var e=a.photos.getAlbum(),g=null;if(e){g=a.storage.get("photos/list/view/"+
e.id);"thumbs"!=g&&"descriptions"!=g&&(g="thumbs");var h=a("#album-list li[rel="+e.id+"]");h.find(".count:first").text(e.count);h.find(".count-new:first").text("");a("#album-list-container").trigger("uncollapse_section",h);if(e.edit_rights)a("#photo-list, .js-photo-list").on("click",".make-key-photo-link",function(){a("#photo-list .key-photo").removeClass("key-photo");$li=a(this).closest("li").addClass("key-photo");e.key_photo_id=$li.data("photo-id");a.post("?module=album&action=keyPhoto",{album_id:e.id,
photo_id:e.key_photo_id})})}g||(g="thumbs");a("#template-photo-"+g).length?(a.photos.list_template="template-photo-"+g,a.photos.renderPhotoList(),a.photos.fixRightToolbar(),a.photos.setTitle(a("#photo-list-name").text()),a.photos.menu.init("list"),a.photos.selectPhotoListView(g),a("#js-photos-view-toggle").waToggle({change:function(b,e,f){b=a(e).attr("data-action");b!==g&&(g=b.replace(/-view$/,""),a.photos.list_template="template-photo-"+g,a.photos.renderPhotoList(),a.photos.selectPhotoListView(g))}}),
a("#photo-list .p-description div, .js-description-editable").on("click",function(){a(this);a(this).height();var b=$_("add description");a(this).inlineEditable({inputType:"textarea",makeReadableBy:["esc"],updateBy:["ctrl+enter"],placeholder:b,placeholderClass:"gray",minSize:{height:40},html:!1,allowEmpty:!0,beforeMakeEditable:function(b){var e=a(this),d=e.parent().find(".full-description:first").html(),g=e.css("font-size"),h=e.css("line-height");b.css({"font-size":g,"line-height":h,"max-width":"100%"});
e.html(d);d=Math.max(e.parents("li:first").find("img").width(),e.width());b.width(d);d=this.id+"-button";g=a("#"+d);g.length||(b.after('<input class="button smallest" type="button" id="'+d+'" value="'+$_("Save")+'"> <em class="hint" id="'+this.id+'-hint">Ctrl+Enter</em>'),a("#"+d).on("click",function(){e.trigger("readable")}));a("#"+this.id+"-hint").show();g.show()},afterBackReadable:function(b,e){var d=a("#"+(this.id+"-button")),f=a(this),g=a(b).val(),h=f.parents("li:first").find(".p-image").attr("href"),
h=/(\d+)[\/]*$/.exec(h),t=null;console.log(b);d.hide();a("#"+this.id+"-hint").hide();g?(f.text(g.truncate(255)),f.parent().find(".js-full-description:first").text(g).html()):f.parent().find(".js-full-description:first").html("");h&&e.changed&&(t=h[1],a.photos.saveField({id:t,type:"photo",name:"description",value:g,fn:function(){}}))},hold:function(){return!this.hasClass("editable")}}).trigger("editable")}),h=a("#photo-list-name"),h.hasClass("editable")&&h.inlineEditable({minSize:{width:350},maxSize:{width:600},
size:{height:30},afterBackReadable:function(b,e){if(!e.changed)return!1;var d=a(b).val(),g=a.photos.getAlbum();g&&a.photos.saveField({id:g.id,type:"album",name:"name",value:d,fn:function(b){"ok"==b.status&&(b=b.data.album,a("#album-list li[rel="+b.id+"] > a > .album-name").html(b.name),a("#p-upload-step2 select[name=album_id] option[value="+b.id+"]").html(b.name),a.photos.setTitle(b.not_escaped_name))}})},hold:function(){return!this.hasClass("editable")}}),h=a("#photo-album-note"),h.hasClass("editable")&&
h.inlineEditable({placeholder:"("+$_("subtitle")+")",placeholderClass:"gray",minSize:{width:350},maxSize:{width:600},size:{height:22},afterBackReadable:function(b,e){if(!e.changed)return!1;var d=a(b).val(),g=a.photos.getAlbum();g&&a.photos.saveField({id:g.id,type:"album",name:"note",value:d})},hold:function(){return!this.hasClass("editable")}}),a("#share-menu-block, #organize-menu-block").bind("recount",function(){var b=a("#photo-list li.selected").length;0<b?a(".count:first",a(this)).text(b).show():
a(".count:first",a(this)).hide()}),a("#p-album-settings").click(function(){var b=a.photos.getAlbum(),e=b?b.id:0,b=a("#album-settings-dialog-acceptor");b.length||(b=a("<div id='album-settings-dialog-acceptor'></div>"),a("body").append(b));b.load("?module=dialog&action=albumSettings&id="+e,function(){a.waDialog({html:a("#album-settings-dialog"),onOpen:function(b,d){var f=b.find("form");f.find(".js-privacy-settings-link").on("click",function(){a(window).resize()});f.on("submit",function(d){d.preventDefault();
b.trigger("change_loading_status",!0);a.post(f.attr("action"),f.serializeArray(),function(d){if("ok"==d.status){var f=function(e){a.post("?module=album&action=savePhotosAccess",e,function(){e.offset+=l;e.offset<=g?f(e):(b.trigger("change_loading_status",!1),location.reload())})},g=d.data.total_count,h=d.data.status,k=d.data.groups,l=d.data.count;d=l;l<g?f({id:e,status:h,groups:k,count:l,offset:d}):(b.trigger("change_loading_status",!1),location.reload())}else if("fail"==d.status)for(h in b.trigger("change_loading_status",
!1),d=d.errors,d)d.hasOwnProperty(h)&&b.find("input[name="+h+"]").addClass("error").parent().find(".errormsg").text(d[h])},"json")})}})});return!1}),a("#p-album-delete, .js-album-delete").click(function(){var b=a.photos.getAlbum(),e=b?b.id:0;a.photos.confirmDialog({url:"?module=dialog&action=confirmDeleteAlbum&id="+e,onSubmit:function(b){var d=parseInt(a("input[name=delete-photos]:checked",b).val()),f;(f=a("input[name=delete-offspring]:checked",b).val())?(f=f.split(",").reverse(),f.push(e)):f=[e];
b.trigger("close");a.photos.setCover();a.photos.deleteAllAlbums(f,d,function(){a.photos.unsetCover()});a.photos.goToHash("");return!1}});return!1}),a("#photo-list").find(".p-description textarea, .p-photo-details textarea, .p-photo-details input").on("select",function(){return!1}),a.photos.hotkey_manager.set("rate"),a.photos.hash!=a.photos.photo_stream_cache.hash&&a.photos.scrollTop(),a("#content").trigger("photos_list_load")):(a("#content").empty(),a.wa.setHash("#/"))},loadPhoto:function(e){if(a.photos.photo_stream_cache.hash!=
a.photos.hash)a.photos.loadNewPhoto(e);else{var g=a.photos.photo_stream_cache.getById(e);g?(a.photos.setTitle(g.name_not_escaped),a.photos.loadPhotoCompletly(g)):(g=a.photos.photo_stack_cache.getById(e))?(a.photos.setTitle(g.name_not_escaped),a.photos.loadPhotoInStack(g)):a.photos.loadNewPhoto(e)}},loadPhotoInStack:function g(h){a.photos.abortPrevLoading();a.photos.hooks_manager.trigger("beforeLoadPhoto",h);a.photos.photo_stack_cache.setCurrent(h);var b=a.photos._chooseProperThumb(h);if("object"===
typeof b.size&&b.size){var d=document.querySelector(".p-one-photo").clientHeight;h.height>=d?a("#photo").height(d).attr("srcset",b.url+" 1x, "+b.url2x+" 2x"):a("#photo").attr("srcset",b.url+" 1x, "+b.url2x+" 2x")}replaceImg(a("#photo"),h.thumb.url+(h.edit_datetime?"?"+Date.parseISO(h.edit_datetime):""),null);a.photos.setNextPhotoLink();b=a.post("?module=photo&action=load",{id:h.id,in_stack:1},function(b){b=b.data;var d=b.photo,d=a.photos.photo_stack_cache.updateById(d.id,d);b.photo=d;a.photos.updateViewChildPhoto(b);
a.photos.hooks_manager.trigger("afterLoadPhoto",d);delete g.xhr},"json");g.xhr=b;a("#photo-name").html(h.name)},updateViewChildPhoto:function(g){var h=g.author,b=g.albums,d=g.exif;g=g.photo;a.photos.renderPhotoImg(g);a("#photo-author").html(tmpl("template-photo-author",{photo:g,author:h}));a.photos.updatePhotoOriginalBlock(g);a("#photo-exif").html(tmpl("template-photo-exif",{exif:d}));a.photos.renderMap(d.GPSLatitude,d.GPSLongitude,g.name);a("#photo-albums").html(tmpl("template-photo-albums",{albums:b}));
a.photos.initPhotoContentControlWidget({frontend_link_template:frontend_link_template,photo:g})},loadNewPhoto:function h(b){a.photos.initClearance();a.photos.widget.loupe.init();h.xhr_map=h.xhr_map||{};h.xhr_map[b]&&h.xhr_map[b].abort();h.xhr_map[b]=a.post("?module=photo&action=load",{id:b,hash:a.photos.hash},function(d){h.xhr_map[b]=null;d=d.data;var f=d.photo;a.photos.renderViewPhoto(d);var k=a.photos.photo_stream_cache.getNext();k&&a.photos.preloadPhoto(k);d.album&&a.photos.setAlbum(d.album);a.photos.hooks_manager.trigger("afterLoadPhoto",
f)},"json")},renderViewPhoto:function(h){var b=h.photo,d=h.author,f=h.exif,k=h.stack,l=h.albums,m=h.album,p=h.hooks,t=h.frontend_link_template,n=h.photo_stream;h=n.in_collection;a.photos.photo_stream_cache.set(n.photos);var r=!1;if(m&&!h){if(m.type==Album.TYPE_STATIC){a.photos.goToHash("album/"+m.id+"/");return}r=!0}a.photos.setTitle(b.name_not_escaped);a("#content").html(tmpl("template-p-block"));a.photos.initPhotoToolbar({photo:b,author:d,exif:f,stack:k});a.photos.renderPhotoBlock({photo:b,hash:a.photos.hash,
albums:l,hooks:p,frontend_link_template:t});setTimeout(function(){a.photos.initPhotoWidgets({photo:b,stack:k,exif:f,photo_stream:n,hash:a.photos.hash})},0);a.photos.anchor?(a.photos.goToAnchor(a.photos.anchor),a.photos.anchor=""):a.photos.scrollTop();a("#p-warning-not-in-album").hide();r?(a("#p-warning-not-in-album").show(),a.photos.setNextPhotoLink(a.photos.photo_stream_cache.getCurrent())):a.photos.setNextPhotoLink()},loadPhotoCompletly:function(h){a.photos.photo_stream_cache.setCurrent(h);a.photos.updatePhotoStreamWidget({shift:h.id,
fn:function(){a.photos._loadPhotoCompletly(h)}})},_loadPhotoCompletly:function b(d){a.photos.abortPrevLoading();a.photos.hooks_manager.trigger("beforeLoadPhoto",d);a("#p-warning-not-in-album").hide();a.photos.setNextPhotoLink();a.photos.updatePhotoName(d.name);a.photos.updatePhotoDescription(d.description);a.photos.updatePhotoRate(d.rate);a("#photo-frontend-url").html(d.url);a("#stack-stream").hide();a("#photo-hook-bottom").html("");var f=a.photos.isPhotoPreloaded(d);if(f)a.photos.renderPhotoImg(d);
else{var k=a.photos._chooseProperThumb(d),l=a("#photo");l.css({opacity:0,display:"none"});var m=document.querySelector(".p-one-photo").clientHeight;d.height>=m&&l.height(m);replaceImg(l,k.url+(d.edit_datetime?"?"+Date.parseISO(d.edit_datetime):""),function(){"object"===typeof k.size&&k.size&&l.attr("srcset",k.url+" 1x, "+k.url2x+" 2x");l.css({opacity:1,display:"block"})})}a.photos.updatePhotoTags(d.tags);(m=a.photos.photo_stream_cache.getNext())&&a.photos.preloadPhoto(m);d=a.post("?module=photo&action=load",
{id:d.id},function(d){if("ok"==d.status){d=d.data;var k=d.album,l=d.photo,m=d.photo_stream.in_collection,p=!1;if(k&&!m){if(k.type==Album.TYPE_STATIC){a.photos.goToHash("album/"+k.id+"/");return}p=!0}p?(a("#p-warning-not-in-album").show(),a.photos.setNextPhotoLink(a.photos.photo_stream_cache.getCurrent())):a.photos.setNextPhotoLink();l=a.photos.photo_stream_cache.updateById(l.id,l);d.photo=l;a.photos.updateViewPhoto(d,f);a.photos.hooks_manager.trigger("afterLoadPhoto",l);delete b.xhr}},"json");b.xhr=
d},updateViewPhoto:function(b,d){var f=b.author,k=b.albums,l=b.exif,m=b.frontend_link_template,p=b.hooks,t=b.stack,n=b.photo;d||a.photos.renderPhotoImg(n);a.photos.updateViewPhotoMenu(0!=n.parent_id||0<n.stack_count,n.edit_rights);a.photos.updatePhotoName(n.name,n.edit_rights);a.photos.updatePhotoDescription(n.description,n.edit_rights);a.photos.updatePhotoRate(n.rate,n.edit_rights);a.photos.updatePhotoTags(n.tags);a("#photo-author").html(tmpl("template-photo-author",{photo:n,author:f}));a.photos.updatePhotoOriginalBlock(n);
a("#photo-exif").html(tmpl("template-photo-exif",{exif:l}));a.photos.renderMap(l.GPSLatitude,l.GPSLongitude,n.name);a("#photo-albums").html(tmpl("template-photo-albums",{albums:k}));a.photos.initPhotoContentControlWidget({frontend_link_template:m,photo:n});t?(a("#stack-stream").html(tmpl("template-photo-stack",{stack:t,photo_id:n.id,hash:a.photos.hash})).show(),a.photos.photo_stack_cache.set(t),a.photos.initPhotoStackWidget()):a.photos.photo_stack_cache.clear();var f="",r;for(r in p.backend_photo)p.backend_photo[r].bottom&&
(f+=p.backend_photo[r].bottom);a("#photo-hook-bottom").html(f);f="";for(r in p.backend_photo)p.backend_photo[r].after_rate&&(f+=p.backend_photo[r].after_rate);f&&(a("#photo-rate").nextAll().remove(),a("#photo-rate").after(f));a.photos.anchor&&(a.photos.goToAnchor(a.photos.anchor),a.photos.anchor="")},renderPhotoImg:function(b){var d=a.photos._chooseProperThumb(b),f=a("#photo");f.css({opacity:0,display:"none"});var k=document.querySelector(".p-one-photo").clientHeight;b.height>=k&&f.height(k);replaceImg(f,
d.url+(b.edit_datetime?"?"+Date.parseISO(b.edit_datetime):""),function(){"object"===typeof d.size&&d.size&&a(this).attr("srcset",d.url+" 1x, "+d.url2x+" 2x");a.photos.hooks_manager.trigger("afterRenderImg",this,b,d);f.css({opacity:1,display:"block"})})},updateViewPhotoMenu:function(b,d){b?a.photos.menu.enable("photo","#photo-organize-menu","unstack"):a.photos.menu.disable("photo","#photo-organize-menu","unstack");d?(a.photos.menu.enable("photo","#photo-organize-menu"),a.photos.menu.enable("photo",
"#edit-menu"),a("#photo-tags").parent().show()):(a.photos.menu.disable("photo","#photo-organize-menu"),a.photos.menu.disable("photo","#edit-menu"),a("#photo-tags").parent().hide())},preloadPhoto:function(b){var d=a("#preload-photo");d.attr("data-photo-id","");replaceImg(d,b.thumb_big.url,function(){d.attr("data-photo-id",b.id)})},isPhotoPreloaded:function(b){return a("#preload-photo").attr("data-photo-id")==b.id},abortPrevLoading:function(){"object"===typeof a.photos._loadPhotoCompletly.xhr&&"function"===
typeof a.photos._loadPhotoCompletly.xhr.abort&&(a.photos._loadPhotoCompletly.xhr.abort(),a.photos.hooks_manager.trigger("onAbortPrevLoading"));"object"===typeof a.photos.loadPhotoInStack.xhr&&"function"===typeof a.photos.loadPhotoInStack.xhr.abort&&(a.photos.loadPhotoInStack.xhr.abort(),a.photos.hooks_manager.trigger("onAbortPrevLoading"))},updateThumbRate:function(b,d){var f=b.find(".p-details .p-rate");(d=Math.round(2*d)/2)?(f.find("svg").removeClass("fa-star-half-alt").attr("data-prefix","far").each(function(b){b+=
1;b>d?.5==b-d&&a(this).addClass("fa-star-half-alt").attr("data-prefix","fas"):a(this).removeClass("fa-star-half-alt").attr("data-prefix","fas")}),f.show()):f.hide()},showManageAccessDialog:function(b,d){var f=a("#manage-access-dialog-acceptor"),k="?module=dialog&action=manageAccess";f.length||(f=a("<div id='manage-access-dialog-acceptor'></div>"),a("body").append(f));if(b)if(a.isArray(b))for(var l=0,m=b.length;l<m;++l)var p=b[l],k=k+("&"+p.name+"="+p.value);else k+="&"+b;f.load(k,function(){a.waDialog({$wrapper:a("#manage-access-dialog"),
onOpen:function(b,f){var k=b.find("form");k.find(".js-privacy-settings-link").on("click",function(){a(window).resize()});k.on("submit",function(a){a.preventDefault();d(b,f)})}})})},initPhotoNameWidget:function(b){b="undefined"===typeof b?!1:b;a("#photo-name").inlineEditable({placeholder:a("#photo-name").text()?null:$_("Edit title..."),placeholderClass:"gray",afterBackReadable:function(b,f){if(f.changed){var d=a(b).val();d.length&&a.photos.saveField({id:a.photos.getPhotoId(),type:"photo",name:"name",
value:d,fn:function(b){a("#photo-name").inlineEditable("setOption",{placeholder:null});"ok"==b.status&&a.photos.setTitle(b.data.value)}})}},minSize:{width:350},maxSize:{width:600},size:{height:30},hold:function(){return!this.hasClass("editable")}});a.photos.updatePhotoName(b)},initPhotoDescriptionWidget:function(b){b="undefined"===typeof b?!1:b;a("#photo-description").inlineEditable({placeholder:$_("add description"),placeholderClass:"gray",makeReadableBy:["esc"],updateBy:["ctrl+enter"],html:!0,allowEmpty:!0,
beforeMakeEditable:function(b){var d=a("#photo-description-save");if(!d.length){var k=a(this);b.after('<input type="button" id="photo-description-save" class="button smallest" value="'+$_("Save")+'"> <em class="hint" id="'+this.id+'-hint">Ctrl+Enter</em>');d=a("#photo-description-save");d.click(function(){k.trigger("readable")})}a("#"+this.id+"-hint").show();d.show().prev("br").show()},afterBackReadable:function(b,f){a("#photo-description-save").hide().prev("br").hide();a("#"+this.id+"-hint").hide();
if(!f.changed)return!1;a(b).val();a.photos.saveField({id:a.photos.photo_stream_cache.getCurrent().id,type:"photo",name:"description",value:a(b).val(),fn:function(){}})},minSize:{height:50,width:600},size:{width:a("#photo").width()},inputType:"textarea",editLink:"#photo-description-edit-link",hold:function(){return!this.hasClass("editable")}});a.photos.updatePhotoDescription(b)},initPhotoRateWidget:function(b){b="undefined"===typeof b?!1:b;a("#photo-rate").rateWidget({onUpdate:function(b){a.photos.saveField(a.photos.photo_stream_cache.getCurrent().id,
"rate",b,function(b){"ok"==b.status&&b.data.count&&a("#rated-count").text(0<b.data.count?b.data.count:"")})},hold:function(){return this.hasClass("hold")}});a.photos.updatePhotoRate(b)},initPhotoStackWidget:function(b){"object"===typeof b&&b&&a("#stack-stream").html(tmpl("template-photo-stack",b)).show();b=a("#stack-stream li.dr:first a").attr("href");(b=/(\d+)[\/]*$/.exec(b))&&(parent_id=b[1]);a("#stack-stream").data("parent_id",parent_id);a("#stack-stream").sortable({distance:5,helper:"clone",items:"li.dr",
opacity:.75,tolerance:"pointer",start:function(){document.ondragstart=function(){return!1}},stop:function(b,f){document.ondragstart=null;var d=a(f.item),l=parseInt(d.attr("data-photo-id")),d=d.next(),m=null;d.length&&(m=parseInt(d.attr("data-photo-id")));a.post("?module=stack&action=photoMove",{id:l,before_id:m},function(b){if("ok"==b.status&&b.data.stack){var d=b.data.stack;b=a("#stack-stream").data("parent_id");var d=d[0],f=d.id;b!=f&&(b=a.photos.photo_stream_cache.getById(b),d.tags=b.tags,a.photos.photo_stream_cache.replace(b,
d),a("#stack-stream").data("parent_id",f),a.photos.updatePhotoStreamWidget({current_photo:d}))}},"json")}});if(a("#stack-stream").data("inited"))return!1;a("#stack-stream li.dr").on("click",function(){a("#stack-stream li.dr.selected").removeClass("selected");a(this).addClass("selected")});a("#stack-stream").data("inited",!0)},initPhotoTagsWidget:function(b){var d=a("#photo-tags"),f=$_("add a tag");"undefined"!==typeof b&&("object"===typeof b&&b&&(b=a.photos.joinObject(b,",")),d.importTags(b));d.data("current_value",
d.val());var k=function(){d.data("current_value")!==d.val()&&(d.data("current_value",d.val()),a("#photo-save-tags-status").html('<i style="vertical-align: middle" class="icon16 yes"></i>'+$_("Saving")).fadeIn("slow"),a.photos.assignTags({photo_id:a.photos.getPhotoId(),tags:a("#photo-tags").val(),fn:function(){a("#photo-save-tags-status").html('<i style="vertical-align: middle" class="icon16 yes"></i>'+$_("Saved")).fadeOut("slow")},onDeniedExist:function(){alert($_("You don't have sufficient access rights"))}}))};
try{d.tagsInput({autocomplete_url:"?module=tag&action=list",height:120,width:150,defaultText:f,onChange:function(){},onAddTag:function(){k()},onRemoveTag:function(){k()}})}catch(l){}},initPhotoContentControlWidget:function(b){"object"===typeof b&&b?(a("#photo-content-control").html(tmpl("template-photo-content-control",b)),edit_rights=b.photo.edit_rights):edit_rights=b;edit_rights="undefined"===typeof edit_rights?!1:edit_rights;var d=a("#photo-frontend-url"),f=d.parents("li:first").find("i.new-window"),
k=a("#photo-frontend-link").nextAll("span.slash:first");d.length&&d.inlineEditable({inputType:"input",editLink:"#photo-frontend-url-edit-link",editOnItself:!1,minSize:{width:100},beforeMakeEditable:function(b){var d=a(this),l=d.text().replace(/\/$/,"");d.text(l);k.show();f.hide();b.removeClass("error");a("#photo-content-control").find(".errormsg").text("").hide()},beforeBackReadable:function(b,m){function l(){t.text(n);k.hide();f.show();a(b).removeClass("error");a("#photo-content-control").find(".errormsg").text("").hide()}
var t=a(this),n=t.text()+"/",r=a.photos.getPhotoId(),q=a(b).val();if(m.changed)return a.photos.saveField(r,"url",q,function(f){"ok"==f.status?(f=a("#photo-frontend-link").text(),a("#photo-frontend-link").attr("href",f),l(),d.trigger("readable",!0)):"fail"==f.status&&(a(b).addClass("error"),a("#photo-content-control").find(".errormsg").text(f.errors.url).show())}),!1;l()},hold:function(){return this.hasClass("hold")}});a.photos.updatePhotoFrontendUrl(edit_rights)},renderMap:function(b,d,f){var k=this.options.map_options||
{},l=function(){};b&&d?(l="google"===k.type?function(){window.initPhotosGoogleMap=function(){if(window.google){a("#photo-map").show();var k=new google.maps.LatLng(b,d),l={zoom:11,center:k,mapTypeId:google.maps.MapTypeId.ROADMAP,disableDefaultUI:!0,zoomControlOptions:{position:google.maps.ControlPosition.TOP_LEFT,style:google.maps.ZoomControlStyle.SMALL}},l=new google.maps.Map(a("#photo-map").get(0),l);new google.maps.Marker({position:k,map:l,title:f})}else a("#photo-map").hide()};if(window.google)initPhotosGoogleMap();
else{var l;l="https://maps.googleapis.com/maps/api/js?sensor=false&key=:KEY&lang=:LOCALE&callback=initPhotosGoogleMap".replace(":KEY",k.key||"").replace(":LOCALE",k.locale||"");a.getScript(l)}}:"yandex"===k.type?function(){var f=function(){window.ymaps?ymaps.ready(function(){a("#photo-map").show();var f=[b,d],k=new ymaps.Map("photo-map",{center:f,zoom:11,controls:["zoomControl","fullscreenControl"]});k.setCenter(f);k.geoObjects.add(new ymaps.Placemark(f,{balloonContent:""}))}):a("#photo-map").hide()};
if(window.ymaps)f();else{var l;l="https://api-maps.yandex.ru/2.1/?lang="+(k.locale||"ru_RU");k.key&&(l+="&apikey="+k.key);a.getScript(l,f)}}:function(){a("#photo-map").hide()},l()):a("#photo-map").hide()},joinObject:function(a,d){var b="",k=0;d=d||"";for(var l in a)a.hasOwnProperty(l)&&(0<k++&&(b+=d),b+=a[l]);return b},initPhotoStreamWidget:function(b){var d=b.photos,d=[null].concat(d,[null]);a("#photo-stream").html(tmpl("template-photo-stream",{photos:d,current_photo:b.current_photo||null,hash:a.photos.hash}));
var f=!1,k=!1;a("#photo-stream ul.photostream:first").photoStreamSlider({backwardLink:"#photo-stream .rewind",forwardLink:"#photo-stream .ff",photoStream:"ul",duration:400,onForward:function m(){if(!f){var b=this,d=b.find("ul").find("li:not(.dummy)"),k=d.filter(".visible"),d=d.filter(":last");15>k.filter(":last").nextAll().length&&"object"!=typeof m.xhr&&(k=d.attr("data-photo-id"),m.xhr=a.post("?module=photo&action=loadList",{id:k,direction:1,hash:a.photos.hash},function(d){if("ok"==d.status){d=d.data.photos;
if(0<d.length)a.photos.photo_stream_cache.append(d);else{f=!0;return}d.push(null);b.trigger("append",tmpl("template-photo-stream-list",{photos:d}))}delete m.xhr},"json"))}},onBackward:function p(){if(!k){var b=this,d=b.find("ul").find("li:not(.dummy)"),f=d.filter(".visible"),d=d.filter(":first");15>f.filter(":first").prevAll().length&&"object"!=typeof p.xhr&&(f=d.attr("data-photo-id"),p.xhr=a.post("?module=photo&action=loadList",{id:f,direction:-1,hash:a.photos.hash},function(d){if("ok"==d.status){d=
d.data.photos;if(0<d.length)a.photos.photo_stream_cache.prepend(d);else{k=!0;return}d.unshift(null);b.trigger("prepend",tmpl("template-photo-stream-list",{photos:d}))}delete p.xhr},"json"))}}})},updatePhotoStreamWidget:function(b){var d=a("#photo-stream ul.photostream:first");if(b.current_photo){var f=d.find("li.selected"),k=b.current_photo;f.attr("data-photo-id",k.id);f.find("a").attr("href","#/photo/"+k.id);f.find("img").attr("src",k.thumb_crop.url)}b.shift&&(d.find("li.selected").removeClass("selected"),
d.find("li[data-photo-id="+b.shift+"]").addClass("selected"),d.trigger("home",[b.fn||function(){},!a.photos.shift_next]),a.photos.shift_next=!1)},updatePhotoName:function(b,d){if("boolean"===typeof b||"undefined"===typeof b)d=b,b=null;var f=a("#photo-name");null!==b&&f.html(b);d?f.addClass("editable"):f.removeClass("editable")},updatePhotoDescription:function(b,d){if("boolean"===typeof b||"undefined"===typeof b)d=b,b=a("#photo-description").html();var f=a("#photo-description"),k,l=$_("add description");
d?(f.addClass("editable"),k=l,a("#photo-description-edit-link").show()):(k=null,b=b!==l?b:"",f.removeClass("editable"),a("#photo-description-edit-link").hide());f.inlineEditable("setOption",{placeholder:k}).html(b).trigger("placeholder",!!k)},updatePhotoRate:function(b,d){if("boolean"===typeof b||"undefined"===typeof b)d=b,b=null;var f=a("#photo-rate");null!==b&&f.rateWidget("setOption","rate",b);d?f.removeClass("hold").show():(f.addClass("hold"),(b=f.rateWidget("getOption","rate"))||f.hide())},updatePhotoTags:function(b){var d=
a("#photo-tags");d.data("current_value",d.val());"undefined"!==typeof b&&("object"===typeof b&&b&&(b=a.photos.joinObject(b,",")),d.importTags(b))},updatePhotoFrontendUrl:function(b){var d=a("#photo-frontend-url");b?(d.removeClass("hold"),a("#photo-frontend-url-edit-link").show()):(d.addClass("hold"),a("#photo-frontend-url-edit-link").hide())},updatePhotoOriginalBlock:function(b){a("#photo-original").html(tmpl("template-photo-original",{photo:b}))},initPhotoToolbar:function(b){setTimeout(function(){a("#p-toolbar").html(tmpl("template-photo-toolbar",
b)).addClass("rendered");a.photos.menu.init("photo");var d=a("#photos-photo-popular-tags");d.data("inited")||d.off("click.photos","a").on("click.photos","a",function(){var b=a(this).text(),d=a("#photo-tags");d.removeTag(b);d.addTag(b)}).data("inited",!0);a.photos.updateViewPhotoMenu(a.isArray(b.stack)&&b.stack.length,b.photo.edit_rights);a(".js-p-toolbar-dropdown").waDropdown({hover:!1,update_title:!1,items:".menu > li > a"})},0)},renderPhotoBlock:function(b){var d=b.photo,f=a.photos._chooseProperThumb(d),
k=d.thumb.size;"object"===typeof f.size&&f.size&&(d.thumb.size={width:f.size.width,height:f.size.height});a("#p-block").html(tmpl("template-photo",b)).addClass("rendered");var l=a("#photo");l.css({opacity:0,display:"none"});setTimeout(function(){function a(a){a=a.getBoundingClientRect();return Math.floor(a.top+pageYOffset)}var b=document.querySelector(".p-one-photo"),f=window.innerHeight-a(b)-16;b.style.height=f+"px";d.height>=f&&l.height(f);window.addEventListener("resize",function(){f=window.innerHeight-
a(b)-16;b.style.height=f+"px";d.height>=f&&l.height(f)})},0);"object"===typeof k&&k&&(d.thumb.size={width:k.width,height:k.height});replaceImg(l,f.url+(d.edit_datetime?"?"+Date.parseISO(d.edit_datetime):""),function(){a(this).attr("srcset",f.url+" 1x, "+f.url2x+" 2x");a.photos.hooks_manager.trigger("afterRenderImg",this,d,f);l.css({opacity:1,display:"block"})})},initPhotoWidgets:function(b){var d=b.photo,f=b.exif,k=b.stack;b=b.photo_stream;var l=a.photos.hash;a.photos.initPhotoNameWidget(d.edit_rights);
a.photos.initPhotoDescriptionWidget(d.edit_rights);a.photos.initPhotoRateWidget(d.edit_rights);a.photos.initPhotoTagsWidget(d.tags);a.photos.initPhotoContentControlWidget(d.edit_rights);a.photos.hotkey_manager.set();a.photos.renderMap(f.GPSLatitude,f.GPSLongitude,d.name);a.isArray(k)&&k.length&&(a.photos.photo_stack_cache.set(k).setCurrentById(d.id),a.photos.initPhotoStackWidget({stack:k,photo_id:d.id,hash:a.photos.hash}));d=a.photos.photo_stream_cache;d.hash=l;d.set(b.photos).setCurrentById(b.current_photo_id);
a.photos.initPhotoStreamWidget({photos:b.photos,current_photo:d.getCurrent()});a("#p-block .p-one-photo > .p-image-nav").on("click",function(){var b=this.classList.contains("p-rewind")?a.photos.photo_stream_cache.getPrev():a.photos.photo_stream_cache.getNext();b&&(a.photos.goToHash(a.photos.getHashByPhotoId(b.id),!1),a.photos.shift_next=!0)})},_chooseProperThumb:function(b){var d=b.thumb_big;b=b.thumb_middle;var f,k=a("#p-block").width();f=d;"object"===typeof d.size&&d.size?(parseInt(d.size.height,
10)>parseInt(b.bound.height,10)&&parseInt(d.size.height,10)>a(window).height()&&(f=b),parseInt(f.size.width,10)>k&&(f.size.height=Math.round(k/parseInt(f.size.width,10)*parseInt(f.size.height,10)),f.size.width=k)):f.size={width:k,height:""};"object"===typeof f.size&&f.size||(f.size={widht:k,height:""});return f},setNextPhotoLink:function(b){var d=a("#photo").parents("a:first");(b=b?b:a.photos.photo_stream_cache.getNext())?(d.attr("title",$_("Next \u2192")),d.attr("href","#"+a.photos.hash+"/photo/"+
b.id+"/")):(d.attr("title",""),d.attr("href","javascript:void(0);"))},setTitle:function(b){b&&(document.title=b+a.photos.options.title_suffix)},ignore_scrolltop:!1,scrollTop:function(){a.photos.ignore_scrolltop?a.photos.ignore_scrolltop=!1:a(document).scrollTop(0)},load:function(b,d,f,k){var l=a("#content");"function"==typeof d&&(k=f||null);k&&(l.empty().append(k),l=l.find(":last-child"));"function"==typeof d?l.load(b,d):l.load(b,d,f)},setCover:function(){a.photos.centralizeLoadingIcon();a("#cover").show()},
unsetCover:function(){a("#cover").hide()},centralizeLoadingIcon:function(){var b=a("#cover"),d=a("#cover .loading"),f=b.width(),k=d.width(),b=b.height(),d=d.height();a(".loading").css({position:"absolute",left:parseInt((f-k)/2)+"px",top:parseInt((b-d)/2)+"px"})},saveField:function(b,d,f,k){var l="photo";1==arguments.length&&(l=a.extend({type:l,fn:function(){}},b),b=l.id,d=l.name,f=l.value,k=l.fn,l=l.type);if(!~["photo","album"].indexOf(l))throw"Unknown type";a.isArray(b)||(b=[{name:"id[]",value:parseInt(b)}]);
var m=[].concat(b,{name:"name",value:d},{name:"value",value:f});a.post("?module="+l+"&action=saveField",m,function(l){if("ok"==l.status){var m={};m[d]=f;l.data.parent_id&&(b=l.data.parent_id);a.photos._updateStreamCache(b,m);"function"==typeof k&&k(l)}else"fail"==l.status&&"function"==typeof k&&k(l)},"json")},saveFields:function(b,d,f){a.post("?module=photo&action=saveFields",{data:b},function(b){if("ok"==b.status)for(var d in b.data.update){var f=b.data.update[d].id;a.isArray(f)||(f=[f]);var k=b.data.update[d].data;
d=0;for(var t=f.length;d<t;++d)a.photos.photo_stream_cache.updateById(f[d],k)}},"json")},_updateStreamCache:function(b,d){a.isArray(b)||(b=[{value:b}]);for(var f=0,k=b.length;f<k;++f)a.photos.photo_stream_cache.updateById(b[f].value,d)},restoreOriginal:function(b,d){d=d||function(){};a.post("?module=photo&action=restore",{id:b},function(f){"ok"==f.status&&(f=f.data.photo,f=0==f.parent_id?a.photos.photo_stream_cache.updateById(b,f):a.photos.photo_stack_cache.updateById(b,f),a.photos.updatePhotoOriginalBlock(f),
a.photos.updatePhotoImgs(f,d))},"json")},rotate:function(b,d,f){f=f||function(){};a.post("?module=photo&action=rotate",{id:b,direction:d},function(d){"ok"==d.status&&(d=d.data.photo,d=0==d.parent_id?a.photos.photo_stream_cache.updateById(b,d):a.photos.photo_stack_cache.updateById(b,d),a.photos.updatePhotoOriginalBlock(d),a.photos.updatePhotoImgs(d,f))},"json").error(function(b){a.photos.showServerError(b.responseText);"function"==typeof f&&f()})},updatePhotoImgs:function(b,d){var f=a.photos._chooseProperThumb(b),
k=b.edit_datetime?"?"+Date.parseISO(b.edit_datetime):"",l=a("#photo");replaceImg(l,f.url+k,function(){var l=document.querySelector(".p-one-photo").clientHeight;b.height>=l?a(this).height(l).attr("srcset",f.url+" 1x, "+f.url2x+" 2x"):a(this).attr("srcset",f.url+" 1x, "+f.url2x+" 2x");a("#photo-stream .selected img, #stack-stream .selected img").each(function(){var d=a(this);d.hasClass("thumb")?d.attr("src",b.thumb.url+k):d.attr("src",b.thumb_crop.url+k)});"function"==typeof d&&d();a.photos.hooks_manager.trigger("afterRenderImg",
this,b,f)})},deletePhotos:function(b,d){a.post("?module=photo&action=resolution",a.isArray(b)?b:{photo_id:b},function(f){if("ok"==f.status){var k=f.data.photo_id;f=[];for(var l=[],m=0,p=k.length;m<p;++m)f.push({name:"photo_id[]",value:k[m]});a.photos.massPost({photo_id:f,url:"?module=photo&action=delete",dataType:"json",data:{photos_length:a.isArray(b)?b.length:1},success:function(a,b){if("ok"==a.status){l=l.concat(a.data.denied_photo_id);for(var d=0,f=l.length;d<f;++d)b.push({name:"denied_photo_id[]",
value:l[d]})}},fullSuccess:function(f){var m;if("ok"==f.status)if(a.isArray(b)){f.data.alert_msg&&alert(f.data.alert_msg);var p={};a.each(k,function(a,b){p[b]=b});f.data.denied_photo_id&&f.data.denied_photo_id.length&&a.each(f.data.denied_photo_id,function(a,b){delete p[b]});p=a.map(p,function(b,d){a.photos.photo_stream_cache.deleteById(k[b]);return d});a("#photo-list li.selected").trigger("select",!1);p.length?a.photos.makeDeleteAnimation(p,function(){d&&d(f)}):d&&d(f)}else{l.length&&alert($_("You don't have sufficient access rights"));
if(f.data.parent_id)m=a.photos.getHashByPhotoId(f.data.parent_id),a.photos.photo_stack_cache.deleteById(k);else{var q=a.photos.photo_stream_cache;m=(m=q.getNext(b))?a.photos.getHashByPhotoId(m.id):q.hash;q.deleteById(k)}a.wa.setHash(m);d&&d(f)}else d&&d(f)}})}},"json")},deleteAllAlbums:function(b,d,f){if(!b.length)return f&&f();var k=b.shift();a.photos.deleteAlbum(k,d,function(){a.photos.deleteAllAlbums(b,d,f)})},deleteAlbum:function(b,d,f){d?a.photos._deleteAlbumWithPhotos(b,f):a.post("?module=album&action=delete",
{album_id:b},function(d){"ok"==d.status&&(a.photos.onDeleteAlbum(b),a.photos.goToHash(""),"function"==typeof f&&f())},"json")},_deleteAlbumWithPhotos:function(b,d){a.post("?module=photo&action=resolution",{album_id:b},function(f){if("ok"==f.status){f=f.data.photo_id;for(var k=[],l=0,m=f.length;l<m;++l)k.push({name:"photo_id[]",value:f[l]});k.length?a.photos.massPost({url:"?module=photo&action=delete",photo_id:k,dataType:"json",fullSuccess:function(f){"ok"==f.status?a.photos.deleteAlbum(b,0,d):console&&
console.log("Error while delete album")}}):a.photos.deleteAlbum(b,0,d)}},"json")},serializeData:function(b,d){if("object"===typeof b&&!a.isArray(b)&&"undefined"===typeof d){var f=[];for(d in b)b.hasOwnProperty(d)&&f.push({name:d,value:b[d]});return f}a.isArray(b)||(b=[b]);for(var f=0,k=b.length,l=b[0];f<k;l=b[++f])"object"!=typeof l&&(l={name:d,value:l}),b[f]=l;return b},saveAccess:function(b){function d(b){for(var d=[],f=[],p=[],q=0,v=b.length;q<v;++q)d.push({name:"photo_id[]",value:b[q]});a.photos.massPost({photo_id:d,
url:"?module=photo&action=manageAccessSave",dataType:"json",data:k,success:function(a,b){if("ok"==a.status){f=f.concat(a.data.denied_photo_id);for(var d=0,k=f.length;d<k;++d)b.push({name:"denied_photo_id[]",value:f[d]});p=a.data.allowed_photo_id;d=0;for(k=p.length;d<k;++d)b.push({name:"allowed_photo_id[]",value:p[d]})}},fullSuccess:function(a){"ok"==a.status&&a.data.alert_msg&&m(a.data.alert_msg);"function"===typeof l&&l(a,p)}})}var f=b.photo_id||[],k=b.data||[],l=b.fn,m=b.onDeniedExist||function(a){alert(a)};
b="boolean"===typeof b.resolution?b.resolution:!0;"object"!==typeof k||a.isArray(k)||(k=a.photos.serializeData(k));k.push({name:"photos_length",value:f.length});b?a.post("?module=photo&action=resolution",a.isArray(f)?f:{photo_id:f},function(a){"ok"==a.status&&d(a.data.photo_id)},"json"):d(a.isArray(f)?f:[f])},addToAlbums:function(b){var d=b.photo_id||[],f=b.album_id||[],k=void 0==b.copy?1:b.copy,l=b.fn,m=b.onDeniedExist||function(a){alert(a)},d=a.photos.serializeData(d,"photo_id[]"),f=a.photos.serializeData(f,
"album_id[]");b=d.concat(f);b.push({name:"copy",value:+k});a.post("?module=photo&action=addToAlbums",b,function(b){if("ok"==b.status){for(var d=[].concat(b.data.albums||[],b.data.old_albums||[]),f=0,k=d.length;f<k;++f){var p=d[f];a("#album-list li[rel="+p.id+"]").find(".count:first").text(p.count).end().find(".count-new:first").text(0<p.count_new?"+"+p.count_new:"")}b.data.alert_msg&&m(b.data.alert_msg)}"function"==typeof l&&l(b)},"json")},assignTags:function(b){var d=b.photo_id||[],f=b.tags||[],
k=b.delete_tags||[],l=b.fn,m=b.onDeniedExist||function(a){alert(a)};b=[];b=a.isArray(d)?d:b.concat([{name:"photo_id[]",value:d},{name:"one_photo",value:1}]);a.isArray(f)&&f.length?b=b.concat(f):(b.push({name:"tags",value:f}),k.length&&(b=b.concat(k)));a.post("?module=photo&action=assignTags",b,function(b){if("ok"==b.status){var d=b.data.cloud,f=a("#tag-cloud-block");a.isArray(d)&&!d.length||!d?f.hide():(a("#tag-cloud").html(tmpl("template-tag-cloud",{cloud:d})),f.show());var d=b.data.tags||{},k;for(k in d)d.hasOwnProperty(k)&&
(f=d[k],a.photos._updateStreamCache(k,{tags:f}));a("#album-create-dialog").remove();b.data.alert_msg&&m(b.data.alert_msg)}"function"==typeof l&&l(b)},"json")},makeStack:function(b,d){var f=b.shift();a.post("?module=photo&action=resolution",b,function(d){if("ok"==d.status){d=d.data.photo_id;for(var k=[],m=[],p=0,t=d.length;p<t;++p)d[p]!=f.value&&k.push({name:"photo_id[]",value:d[p]});a.photos.massPost({photo_id:k,data:{parent_id:f.value,photos_length:b.length},url:"?module=stack&action=make",dataType:"json",
success:function(a,b){if("ok"==a.status&&"ok"==a.status){m=m.concat(a.data.denied_photo_ids);for(var d=0,f=m.length;d<f;++d)b.push({name:"denied_photo_id[]",value:m[d]})}},fullSuccess:function(d){if("ok"==d.status){d.data.alert_msg&&alert(d.data.alert_msg);for(var k=0,l=b.length;k<l;++k)a.photos.photo_stream_cache.deleteById(b[k].value);a.photos.photo_stream_cache.updateById(d.data.parent_id,d.data.photo);a("#photo-list li.selected").trigger("select",!1);a.photos.makeStackAnimation([f].concat(b))}}})}},
"json")},makeStackAnimation:function(b,d){var f=b[0].value,k=a('li[data-photo-id="'+f+'"]'),l=k.offset(),m=a(window);(l.top<m.scrollTop()||l.top>m.scrollTop()+m.height())&&a("html, body").animate({scrollTop:l.top},300);for(var m=[],p=1;p<b.length;p++){var t=b[p].value,n=a('li[data-photo-id="'+t+'"]'),r=n.offset(),r=n.clone().css({"z-index":10,position:"absolute",top:r.top,left:r.left}).insertAfter(n);n.css({opacity:0});m.push(n.hide(300).promise());a.photos.photo_stream_cache.deleteById(t);m.push(r.animate({top:l.top,
left:l.left},300).promise().done(function(){a(this).remove()}))}a.when.apply(a,m).done(function(){var b=k.hasClass("last");k.replaceWith(tmpl(a.photos.list_template,{photos:[a.photos.photo_stream_cache.getById(f)],hash:a.photos.hash,last_login_time:a.photos.options.last_login_time,options:{}}));b||a('li[data-photo-id="'+f+'"]').removeClass("last");a('li[data-photo-id="'+f+'"]').addClass("highlighted");"function"===typeof d&&d()})},makeDeleteAnimation:function(b,d){var f={};a.each(b,function(a,b){f[b]=
!0});var k=a("#photo-list").children().filter(function(){return!!f[a(this).data("photo-id")]}).animate({width:0},function(){k.remove();d&&d()})},highlightSidebarItem:function(){var b=decodeURIComponent(a.photos.hash);a("#js-app-sidebar li.selected").removeClass("selected");var d=a('#js-app-sidebar li a[href="#'+(b||"/")+'"]');d.length||(d=a('#js-app-sidebar li a[href^="#'+(b||"/")+'"]'));d.length&&d.parents("li:first").addClass("selected")},toggleFullScreen:function(){a.storage.get("photos/maximize_photo")?
a("#wa-app").addClass("p-full-screen"):a("#wa-app").removeClass("p-full-screen")},hotkey_manager:function(){function b(d){var f=d.target.type;d=d.keyCode;if(!(b.hold||"text"==f||"textarea"==f||37!=d&&39!=d)){if(39==d){if(f=a.photos.photo_stream_cache.getNext())a.photos.goToHash(a.photos.getHashByPhotoId(f.id),!1),a.photos.shift_next=!0;b.hold=!0}if(37==d){if(f=a.photos.photo_stream_cache.getPrev())a.photos.goToHash(a.photos.getHashByPhotoId(f.id),!1),a.photos.shift_next=!0;b.hold=!0}}}function d(a){b.hold=
!1}function f(a){switch(a){case 48:case 96:a=0;break;case 49:case 97:a=1;break;case 50:case 98:a=2;break;case 51:case 99:a=3;break;case 52:case 100:a=4;break;case 53:case 101:a=5;break;default:a=null}return a}function k(b){var d=b.target.type;if(!k.hold&&"text"!=d&&"textarea"!=d){var l=f(b.keyCode);"number"===typeof l&&(k.hold=!0,a("#photo").length?(b=a.photos.photo_stream_cache.getCurrent(),b.edit_rights&&a.photos.saveField(b.id,"rate",l,function(b){"ok"==b.status&&b.data.count&&(a("#rated-count").text(0<
b.data.count?b.data.count:""),a("#photo-rate").rateWidget("setOption","rate",l))})):(b=a("input[name^=photo_id]").map(function(){return this.checked?{name:"id[]",value:this.value}:null}).toArray(),b.length&&a.photos.saveField({id:b,name:"rate",value:l,fn:function(b){if("ok"==b.status){var d=b.data.allowed_photo_id&&!a.isArray(b.data.allowed_photo_id)?b.data.allowed_photo_id:{};a("#photo-list li.selected").each(function(){var b=a(this);d[b.attr("data-photo-id")]&&a.photos.updateThumbRate(b,l)}).find("input:first").trigger("select",
!1);b.data.count&&a("#rated-count").text(0<b.data.count?b.data.count:"");b.data.alert_msg&&alert(b.data.alert_msg)}}})))}}function l(){k.hold=!1}return{set:function(f){"undefined"===typeof f?a(document).bind("keydown",b).bind("keyup",d).bind("keydown",k).bind("keyup",l):"rate"===f&&a(document).bind("keydown",k).bind("keyup",l)},unset:function(){a(document).unbind("keydown",b).unbind("keyup",d).unbind("keyup",k).unbind("keyup",l)}}}(),getHashByPhotoId:function(b){return a.photos.hash+"/photo/"+b},
setLazyLoad:function(){var b=null;a(window).lazyLoad({container:"#photo-list",load:function(){b=b||a("#photo-list li").length;a(window).lazyLoad("sleep");a(".lazyloading-wrapper .lazyloading-progress").show();a(".lazyloading-wrapper .lazyloading-link").hide();a.post("?module=photo&action=loadList",{offset:b,hash:a.photos.hash},function(d){if(d.data.hash==a.photos.hash){var f=a("#photo-list");if(d.data.photos.length){var k=a.photos.photo_stream_cache.length();a.photos.photo_stream_cache.append(d.data.photos);
f.find("li.last").removeClass("last");a.photos.renderPhotoListChunk(f,k,{string:d.data.string},function(){!a.photos.total_count||a.photos.total_count>a.photos.photo_stream_cache.length()?a(window).lazyLoad("wake"):(a(".lazyloading-wrapper .lazyloading-progress").hide(),a(".lazyloading-wrapper .lazyloading-link").hide(),a(window).lazyLoad("stop"))});b+=d.data.photos.length}else a(".lazyloading-wrapper .lazyloading-progress").hide(),a(".lazyloading-wrapper .lazyloading-link").hide(),a(window).lazyLoad("stop")}},
"json")}});a(".lazyloading-wrapper a.lazyloading-link").off("click.lazyloading").on("click.lazyloading",function(){a(window).lazyLoad("force");return!1})},unsetLazyLoad:function(){a(window).lazyLoad&&a(window).lazyLoad("stop");a(".lazyloading-wrapper a.lazyloading-link").die("click.lazyloading")},getAlbum:function(){return this.album=this.album||null},setAlbum:function(a){this.album=a},unsetAlbum:function(){this.album=null},getPhotoId:function(){var a=/photo\/(\d+)[\/]*$/.exec(location.href);return a?
parseInt(a[1]):null},isCurrentPhotoStack:function(){var a=this.getPhotoId();return a?(a=this.photo_stream_cache.getById(a))&&0<a.stack_count:!1},goToHash:function(b,d){d="undefined"===typeof d?!0:d;b=b.replace(/^\/*/,"").replace(/\/*\s*$/,"");location.hash.replace(/^[^#]*#\/*/,"").replace(/\/*\s*$/,"")==b&&d?(a.photos.ignore_scrolltop=!0,a.photos.dispatch()):location.hash=b?"/"+b+"/":"#/"},goToAnchor:function(b){b=a("a[name="+b+"]");b.length&&a(document).scrollTop(b.position().top)},photo_stream_cache:new PhotoStream,
onCreateAlbum:function(b,d){var f=tmpl("template-album-list-item",b),k=a("#album-list"),l;if(d){var m=k.find("li[rel="+d+"]");l=m.find("ul:first");l.length||(m.append('<ul class="menu"></ul>'),l=m.find("ul:first"),m.find(".count:first").after('<i class="icon16 darr overhanging collapse-handler" id="album-'+d+'-handler"></i>'));l.prepend(f)}else l=k.find("ul:first"),l.length||(k.find(".p-empty-album-list").hide(),k.prepend('<ul class="menu"><li class="drag-newposition"></li></ul>').find("ul:first")),
k.find("ul:first").prepend(f);k.find(".new-item").removeClass("new-item").mouseover();b.type||(f=a("#p-upload-step2 select[name=album_id]"),d?(f=f.find("option[value="+d+"]"),k=f.text().replace(/[^-]/g,"")+"-",f.after('<option value="'+b.id+'">'+k+" "+b.name+"</option>")):f.find("optgroup").prepend('<option value="'+b.id+'">'+b.name+"</option>"))},onDeleteAlbum:function(b){var d=a("#album-list"),f=d.find("li[rel="+b+"]"),k=f.find("ul:first"),l=f.parents("ul:first"),m;f.hide();k.length?(f.prev(".drag-newposition:first").remove(),
f.next(".drag-newposition:first").remove(),m=k.children("li"),m.hide().insertAfter(f),k.remove(),f.remove(),m.show()):f.next(".drag-newposition:first").remove().end().remove();l.length&&!l.find("li:not(.drag-newposition)").length&&(f=l.parent("li"),f.length&&f.find("i.collapse-handler").remove(),l.remove());d.find("ul:first").length||d.find(".p-empty-album-list").show();a("#p-upload-step2 select[name=album_id]").find("option[value="+b+"]").remove()},fixRightToolbar:function(){a.photos.fixRightToolbar._handler=
function d(){var f=a("#p-toolbar");f.length&&(f.hasClass("rendered")?f.removeClass("p-fixed"):(d.top||(d.top=f.children(":first").position().top),a(this).scrollTop()>d.top?f.addClass("p-fixed"):f.removeClass("p-fixed")))};a.photos.fixRightToolbar._handler.call(document);a(document).bind("scroll",a.photos.fixRightToolbar._handler)},photo_stack_cache:new PhotoStream,isSelectedAnyPhoto:function(){return!!a("#photo-list li.selected:first").length},getRatingHtml:function(a,d,f){a=Math.round(2*a)/2;if(!a&&
!f)return"";d="";for(f=1;5>=f;f+=1)d+='<i class="fa-star',d=f>a?.5==f-a?d+"-half fas":d+" far":d+" fas",d+='"></i>';return d},uploadDialog:function(){var b=a("#p-uploader");a.waDialog({$wrapper:b,onOpen:a.photos.onUploadDialog})},dialogClearSteps:function(){var b=a(this);b.find("#p-upload-step2").hide();b.find("#p-upload-step2-buttons").hide();b.find("#p-upload-step3").hide();b.find("#p-upload-step3-buttons").hide();b.find("#p-upload-step1").show();b.find("#p-upload-step1-buttons").show()},onUploadDialog:function(){var b=
this.$wrapper;b.find(".files").empty();var d=a.storage.get("photos/hash"),f=b.find("#p-upload-step2 select[name=album_id]");d&&~d.indexOf("album")?(d=parseInt(d.replace(/\/?album\//,"")),d=f.find("optgroup option[value="+d+"]"),d.length?d.attr("selected",!0):f.find("option:first").attr("selected",!0)):f.find("option:first").attr("selected",!0);b.find("form").on("submit",function(b){b.preventDefault();a(this).find("#p-start-upload-button").click()})},massPost:function(b){function d(d){p?(t?(k=t.splice(0,
f),b.data=l.concat(k)):b.data=l,p-=f,p=0<p?p:0,a.ajax(b)):"function"==typeof b.fullSuccess&&b.fullSuccess(d)}var f=b.chunk_count||25,k,l=[];if(a.isArray(b.data))l=l.concat(b.data);else if("object"==typeof b.data)for(var m in b.data)l.push({name:m,value:b.data[m]});b.type="post";var p=parseInt(b.count)||0,t=b.photo_id;if(b.photo_id){t=b.photo_id;if(a.isArray(t))t=[].concat(t);else{l.push({name:"photo_id",value:t});b.data=l;b.success=b.fullSuccess;a.ajax(b);return}p=t.length}if("function"==typeof b.success){var n=
b.success;b.success=function(a){n(a,l);d(a)}}else b.success=d;d()},confirmDialog:function(b){var d=a("#confirm-dialog");d.length||(d=a('<div id="confirm-dialog"></div>'),a("body").append(d));b.url&&d.load(b.url,function(){var d=a.extend({},b);delete d.url;var k=a(this),l=d.onOpen,m=d.onSubmit,p=d.attr||null;d.onOpen=function(a,b){if(p)for(var d in p)p.hasOwnProperty(d)&&a.attr(d,p[d]);a.find("input[type=submit]").focus();"function"===typeof l&&l(a,b);if("function"===typeof m)a.find("form").on("submit",
function(){m(a)})};delete d.onSubmit;d.$wrapper=k.find("div:first");a.waDialog(d)})},showServerError:function(a){a?(console&&console.log("Server error occurred:\n"+a),alert(a)):console&&console.log("Server error occurred")},initAlbumThumbsDragAndDrop:function(b,d){b.sortable({handle:"img",distance:5,tolerance:"pointer",stop:function(b,k){a.post("?module=album&action=move",{id:k.item.data("album-id"),before_id:k.item.next().data("album-id")||0,parent_id:d})}})},hooks_manager:{handlers:{},bind:function(a,
d,f){if(1==arguments.length&&arguments[0]&&"object"===typeof arguments[0]){var b=arguments[0];for(a in b)b.hasOwnProperty(a)&&this.bind(a,b[a])}else return f=f||(""+Math.random()).slice(2),this.handlers[a]=this.handlers[a]||{},this.handlers[a][f]=d,d.handler_name=f},unbind:function(a,d){var b=d;"undefined"===typeof d?this.handlers[a]={}:("function"===typeof d&&(b=d.handler_name),"function"===typeof this.handlers[a][b]&&delete this.handlers[a][b])},trigger:function(a){var b=this.handlers[a];if(b&&
"object"===typeof b){var f=Array.prototype.slice.call(arguments,1),k;for(k in b)b.hasOwnProperty(k)&&"function"===typeof b[k]&&b[k].apply(null,f)}}}}})(jQuery);
$(function(){$(".p-one-photo .next").on("click",function(){$.photos.shift_next=!0});$(".dialog").off().on("change_loading_status",function(a,c){c=c||!1;var e=$(this).find("input[type=submit]");c?e.attr("disabled",!0).after('<i class="fas fa-spin fa-spinner loading"></i>'):e.attr("disabled",!1).next("i").remove()});(function(){var a=!1;$(document).on("selectstart","#photo-list",function(){return!a});$(document).keydown(function(c){16==c.keyCode&&(a=!0)}).keyup(function(c){16==c.keyCode&&(a=!1)})})();
$("#photo-list li").on("select",function(a,c,e){e=void 0!==e?e:!0;(void 0!==c?c:1)?$(this).addClass("selected").find("input:first").attr("checked",!0):(a=$("#selector-menu").find('[data-action="select-photos"]'),a.data("checked")&&a.data("checked",!1).find(".unchecked").show().end().find(".checked").hide(),$(this).removeClass("selected").find("input:first").attr("checked",!1));e&&$("#share-menu-block, #organize-menu-block").trigger("recount")});(function(){function a(a,c,b){if(a&&c&&a[0]&&c[0]&&!a.is(c[0])){var d=
!1;c.parent().children().each(function(e,g){if(d){if(a.is(g)||c.is(g))return!1;var f=$(g).find(".p-details input:checkbox");f.prop("checked")!=b&&f.prop("checked",b).change()}else if(a.is(g)||c.is(g))d=!0})}}var c=null,e=null;$("#content").on("click","#photo-list li .p-details input:checkbox, #photo-list li .p-details label, #photo-list li .p-details .wa-checkbox",function(g){var h=$(this).closest("li"),b=h.find(".p-details input:checkbox"),d;b.is(g.target)?d=b.prop("checked"):(d=!b.prop("checked"),
b.prop("checked",d).change());d?(g.shiftKey&&c&&a(c,h,!0),c=h,e=null):(g.shiftKey&&e&&a(e,h,!1),c=null,e=h);g=$(".js-toolbar-dropdown").find(".dropdown-toggle");$('#photo-list :checkbox[name="photo_id[]"]:checked').length?g.removeClass("nobutton"):g.addClass("nobutton")})})();$("#content").off($.photos.namespace+"-photo-list-select-checkbox").on("change"+$.photos.namespace+"-photo-list-select-checkbox",':checkbox[name="photo_id[]"]',function(){this.checked?$(this).closest("li").addClass("selected"):
$(this).closest("li").removeClass("selected");$("#share-menu-block, #organize-menu-block").trigger("recount")});$.photos.hooks_manager.bind("afterLoadPhoto",function(){$.photos.photo_stream_cache.getPrev()?$("#p-block .p-one-photo > .p-image-nav.p-rewind").show():$("#p-block .p-one-photo > .p-image-nav.p-rewind").hide();$.photos.photo_stream_cache.getNext()?$("#p-block .p-one-photo > .p-image-nav.p-ff").show():$("#p-block .p-one-photo > .p-image-nav.p-ff").hide()});$.photos_dragndrop.init()});
function ToolbarMenu(a,c){var e=null;return{init:function(){e=$(a);e.length&&e.activeMenu(c);return this},enable:function(a){a?e.activeMenu("enable",a):(e.parents("section:first").show(),e.activeMenu("fire"));return this},disable:function(a){a?e.activeMenu("disable",a):e.parents("section:first").hide();return this},setAction:function(a,h){c[a]=h;e&&e.activeMenu("setOption",a,h);return this},getAction:function(a){return c[a]},is:function(c){return e?e.is(c):$(a).is(c)}}};(function(a){a.photos.menu.register("list","#share-menu",{embedAction:function(){var c=a("#embed-photo-list-dialog"),e=a.storage.get("photos/embed_size"),g=a("#photo-list li.selected").map(function(){var b=a(this).attr("data-photo-id"),c=a.photos.photo_stream_cache.getById(b);0>=c.status&&(b+=":"+c.hash);return b}).toArray().join(","),h=a.photos.getAlbum(),b=a.photos.hash,d={photo_ids:g,hash:b,size:e};h&&0>=h.status&&(b=b.replace(/\/*$/,"")+":"+h.hash+"/",d.hash=b);h="?module=dialog&action=embedPhotoList&photo_ids="+
g+"&hash="+b;e&&(h+="&size="+e);c.length||(c=a('<div id="embed-photo-list-dialog"></div>'),a("body").append(c));c.load(h,function(){a.waDialog({$wrapper:c.find("div:first"),onOpen:function(b,c){function f(c){var d=f.data,e=!1,g;for(g in d)if(d.hasOwnProperty(g)&&d[g]!==c[g]){e=!0;break}f.data=a.extend({},c);e&&(b.find(".dialog-header").find(".loading").parent().show(),a.post("?module=photo&action=embedList",c,function(c){if("ok"==c.status){var d=c.data.context;b.find("input[name=link]").val(d.link);
b.find("a.link").attr("href",d.link);b.find("textarea[name=urls]").val(d.urls);r.val(d.html);n.val(d.html_with_descriptions);b.find("textarea[name=smarty_code]").val(d.smarty_code);b.find("h1 span:first").text("("+d.count+")");d.all_public?b.find(".exclamation-message").hide():b.find(".exclamation-message").show();d.domains=d.domains||{};q.children().each(function(){var b=a(this),c=b.attr("value");b.data("frontend-url",(d.domains[c]||{}).frontend_url||"")});h();k()}b.find(".dialog-header").find(".loading").parent().hide()},
"json"))}function h(){a.each(["textarea[name=urls]","#embed-photo-list-html","#embed-photo-list-html-with-descriptions"],function(b,c){var d=a(c);d.data("context_data",d.val())})}function k(){if(!q.length)return!1;a.each(["textarea[name=urls]","#embed-photo-list-html","#embed-photo-list-html-with-descriptions"],function(b,c){var d=a(c);d.val(d.data("context_data").split(q.data("original-domain")).join(q.val()))});var c=q.children(":selected");c.data("frontend-url")?(b.find("input[name=link]").val(c.data("frontend-url")).closest(".field").slideDown(),
b.find("a.link").attr("href",c.data("frontend-url"))):b.find("input[name=link]").closest(".field").slideUp()}var t=b.find("select[name=size]"),n=a("#embed-photo-list-html-with-descriptions"),r=a("#embed-photo-list-html");e&&t.val(e);t.change(function(){var b=a(this).val();d.size=b;f(d);a.storage.set("photos/embed_size",b)});b.find("input[name=description]").on("click",function(){this.checked?(n.show().attr("disabled",!1),r.hide().attr("disabled",!0)):(r.show().attr("disabled",!1),n.hide().attr("disabled",
!0))});b.find("input[name=link], textarea[name=urls], textarea[name=html], textarea[name=smarty_code]").on("click",function(){var b=a(this);b.getSelection().length||b.select()});b.find("input[name=link]").focus().select();b.find(".switcher").activeMenu({selectedPhotosAction:function(a){d.size=b.find("select[name=size]").val();d.photo_ids=g;f(d)},allListPhotosAction:function(a){d.size=b.find("select[name=size]").val();d.photo_ids="";f(d)}}).find("li").click(function(){a(this).parent().find(".selected").removeClass("selected").end().addClass("selected")});
f.data=f.data||a.extend({},d);var q=b.find("select[name=domain]");q.length&&(h(),k(),q.change(k))}})});return!1},beforeAnyAction:function(c){if(!a.photos.isSelectedAnyPhoto()&&"blog-post"!=c&&"embed"!=c)return alert($_("Please select at least one photo")),!1},blogPostAction:function(){for(var c=a("#blog-post-form"),e=[].concat($jscomp.arrayFromIterable(document.querySelectorAll("#photo-list li.selected"))).map(function(a){return a.getAttribute("data-photo-id")}),g=[0,0],h=0;h<e.length;h++){var b=
a.photos.photo_stream_cache.getById(e[h]);b||(b=a.photos.photo_stack_cache.getById(e[h]));b&&(b.hash&&(e[h]+=":"+b.hash),++g[b.status])}var h=a.photos.getAlbum(),b=a.photos.hash,d={photo_ids:e.join(","),hash:b,size:obligatory_size};h&&0>=h.status&&(b=b.replace(/\/*$/,"")+":"+h.hash+"/",d.hash=b);d.hash=null;a("#photo-blog-dialog :submit").attr("disabled",!0);a.post("?module=photo&action=embedList",d,function(b){"ok"==b.status&&(b=b.data.context,c.find('[name="title"]:input').val(a("#photo-list-name").text()),
c.find('[name="text"]:input').val(blog_smarty_enabled?b.smarty_code:b.html_with_descriptions),g[0]?a("#photo-blog-dialog :submit").attr("disabled",!1):c.submit())},"json");g[0]&&(h=a("#photo-blog-dialog").clone(),a.waDialog({$wrapper:h,onOpen:function(a){var b=a.find('[type="submit"]');a=a.find("p");var d=[g[0],e.length];a.html(a.html().replace(/(%d)/g,function(){return d.shift()}));b.on("click",function(a){a.preventDefault();c.submit()})}}));return!1},onFire:function(){a("#share-menu").trigger("recount")}});
a.photos.menu.register("list","#organize-menu",{addToAlbumAction:function(){var c=a("#choose-albums");c.length&&c.parent().remove();a("<div></div>").appendTo("body").load("?module=dialog&action=albums",function(){a.waDialog({$wrapper:a("#choose-albums"),onOpen:function(c,g){c.find("h3:first span:first").text("("+a("#photo-list li.selected").length+")");var e=c.find('[type="submit"]'),b=c.find("form");e.on("click",function(d){d.preventDefault();d=a("input[name^=photo_id]").serializeArray();var e=b.serializeArray();
if(!e.length)return alert($_("Please select at least one album")),!1;if(!d.length)return g.close(),!1;c.trigger("change_loading_status",!0);a.photos.addToAlbums({photo_id:d,album_id:e,copy:1,fn:function(){a("#photo-list li.selected").trigger("select",!1);c.trigger("change_loading_status",!1);g.close()}})})}})})},assignTagsAction:function(){var c=$_("add a tag"),e=a("#photo-list-tags-dialog"),g=e.clone(),h;a.waDialog({$wrapper:g,onOpen:function(b,d){var f=b.find("#photos-list-tags"),g=[],l={},m=a.photos.photo_stream_cache.getAll(),
p=b.find("#photos-tags-remove-list"),t=b.find("#photo-tags-remove"),n=b.find("form"),r=a("input[name^=photo_id]:checked"),q=b.find("#photos-popular-tags");h=e.detach();b.find(".tagsinput").length||(a.fn.tagsInput.bind(f),f.tagsInput({autocomplete_url:"?module=tag&action=list",height:200,width:"100%",defaultText:c}));f.importTags("");b.find(".js-selected-counter").text("("+r.length+")");r.each(function(){g.push(a(this).val())});for(var v={},w=0,u=a.photos.photo_stream_cache.length();w<u;v={p:v.p},
w++)if(v.p=m[w],g.some(function(a){return function(b){return b==a.p.id}}(v))){var x=v.p.tags;if(!a.isEmptyObject(x))if(a.isEmptyObject(l))l=x;else for(var y in x)x.hasOwnProperty(y)&&(l[y]=x[y])}p.empty();if(jQuery.isEmptyObject(l))t.hide();else{t.show();for(var z in l)p.append(a("<label></label>").text(l[z]).prepend('<input name="delete_tags[]" value="'+z+'" type="checkbox"> ')).append("<br>")}q.off("click.photos","a").on("click.photos","a",function(){var b=a(this).text();f.removeTag(b);f.addTag(b)});
l=b.find("#photos-list-tags_tag");l.length&&l.val()!=c&&(m=jQuery.Event("keypress",{which:13}),l.trigger(m));n.on("submit",function(c){c.preventDefault();c=r.serializeArray();var e=f.val(),g=p.find("input[name^=delete_tags]:checked").serializeArray();console.log(e);console.log(a("#photo-list-tags-dialog #photos-list-tags").val());if(!e.length&&!g.length)return alert($_("Please select at least one tag")),!1;if(!c.length)return d.close(),!1;b.trigger("change_loading_status",!0);a.photos.assignTags({photo_id:c,
tags:e,delete_tags:g,fn:function(c){if("ok"==c.status){c=c.data.tags;var e=a("#photo-list li.selected"),f,g;for(g in c)c.hasOwnProperty(g)&&(f=tmpl("template-photo-list-photo-tags",{tags:c[g]}),e.filter("[data-photo-id="+g+"]:first").find(".tags>span").html(f));e.trigger("select",!1);b.trigger("change_loading_status",!1);d.close()}}})})},onClose:function(){a("body").append(h)}})},deleteFromAlbumAction:function(){var c=a("input[name^=photo_id]").serializeArray();if(c.length){var e=a.photos.getAlbum().id;
a.post("?module=photo&action=deleteFromAlbum&id="+e,c,function(){a.photos.dispatch()},"json")}},deletePhotosAction:function(){var c=a("input[name^=photo_id]").serializeArray();c.length&&a.photos.confirmDialog({url:"?module=dialog&action=confirmDeletePhotos&cnt="+c.length,onSubmit:function(e){e.trigger("change_loading_status",!0);a.photos.deletePhotos(c,function(){a.photos.unsetCover();e.trigger("change_loading_status",!1).trigger("close");a("#photo-list li.selected").trigger("select",!1)});return!1}})},
setRateAction:function(){a.photos.confirmDialog({url:"?module=dialog&action=rates",attr:{id:"set-rate"},onOpen:function(c,e){c.find(".p-rate-photo-counter").text("("+a("input[name^=photo_id]:checked").length+")");var g=c.find("#photos-rate");g.rateWidget({withClearAction:!1,onUpdate:function(){var c=g.rateWidget("getOption","rate"),b=a("input[name^=photo_id]").map(function(){return this.checked?{name:"id[]",value:this.value}:null}).toArray();if(!b.length)return e.close(),!1;a.photos.saveField({id:b,
name:"rate",value:c,fn:function(b){if("ok"==b.status){b=b.data;var d=b.allowed_photo_id&&!a.isArray(b.allowed_photo_id)?b.allowed_photo_id:{};a("#photo-list li.selected").each(function(){var b=a(this);d[b.attr("data-photo-id")]&&a.photos.updateThumbRate(b,c)}).find("input:first").trigger("select",!1);b.count&&a("#rated-count").text(0<b.count?b.count:"");b.alert_msg&&alert(b.alert_msg);e.close()}}});return!1}})}})},makeStackAction:function(){var c=a("input[name^=photo_id]").serializeArray();if(2>c.length)return alert($_("Please select at least two photos")),
!1;a.photos.makeStack(c);return!1},manageAccessAction:function(){var c=a("input[name^=photo_id]").serializeArray();a.photos.showManageAccessDialog(c,function(e,g){var h=e.serializeArray(),b=e.find("input[name=status]:checked").val();c.length||g.close();e.trigger("change_loading_status",!0);var d=a("#photo-list li.selected");a.photos.saveAccess({photo_id:c,data:h,fn:function(c,h){for(var f=0,k=h.length;f<k;++f){var p=d.filter("[data-photo-id="+h[f]+"]:first").find(".p-image-corner.top.left");p.find(".fa-lock").remove();
0>=b&&p.append('<i class="fas fa-lock p-private-photo" title="'+$_("Private photo")+'"></i>')}a.photos._updateStreamCache(h,{status:b});d.trigger("select",!1);e.trigger("change_loading_status",!1);g.close()}});return!1});return!1},beforeAnyAction:function(c){if("make-stack"!=c&&!a.photos.isSelectedAnyPhoto())return alert($_("Please select at least one photo")),!1},onFire:function(){a("#organize-menu").trigger("recount")}});a.photos.menu.register("list","#save-menu",{saveDescriptionAction:function(){var c=
{},e,g,h;a("#photo-list.p-descriptions :text,#photo-list.p-descriptions textarea").each(function(){if(this.defaultValue!=this.value&&(e=a(this).attr("name").match(/^photo\[(\d+)\]\[(\w+)\]$/))){g=e[1];h=e[2];var b=a.photos.photo_stream_cache.getById(g);b&&this.value==b[h]||(c[g]||(c[g]={id:g}),c[g][h]=this.value)}});a.photos.saveFields(c);a("#photo-list.p-descriptions :text.highlighted,#photo-list.p-descriptions textarea.highlighted").each(function(){a(this).removeClass("highlighted")});var b=a("#save-menu-block .count.indicator");
b.length&&(b.text(0),a("#save-menu-block input.button").removeClass("yellow"),b.hide());return!1},hideNameAction:function(c,e){var g=c.find(":checkbox"),h=g.prop("checked");"INPUT"!=e.target.tagName&&(h=!h);h?(a('#photo-list li :text[name$="[name]"]').hide(),a('#photo-list li textarea[name$="[description]"].js-small').css("height","+=27").removeClass("js-small").addClass("js-big")):(a('#photo-list li :text[name$="[name]"]').show(),a('#photo-list li textarea[name$="[description]"].js-big').css("height",
"-=27").removeClass("js-big").addClass("js-small"));setTimeout(function(){g.attr("checked",h)},50);a.storage.set("photos/list/hide_name",h)},onFire:function(){var c=a("#save-menu-block .count.indicator");c.length&&(c.text("0"),a("#save-menu-block input.button").removeClass("yellow"),c.hide())},onInit:function(c){c.find('[data-action="hide-name"] :checkbox').prop("checked",a.storage.get("photos/list/hide_name",!1));c=function(){var c=[],g;a("#photo-list.p-descriptions :text,#photo-list.p-descriptions textarea").each(function(){if(this.defaultValue!=
this.value&&(g=a(this).attr("name").match(/^photo\[(\d+)\]\[(\w+)\]$/))){var b=g[1];if(0>c.indexOf(b)){var e=a.photos.photo_stream_cache.getById(b);e&&this.value==e[g[2]]?a(this).hasClass("highlighted")&&a(this).removeClass("highlighted"):(a(this).addClass("highlighted"),c.push(b))}}else a(this).hasClass("highlighted")&&a(this).removeClass("highlighted")});var h=a("#save-menu-block .count.indicator"),b=c.length;h.length&&h.text(b);b?(a("#save-menu-block input.button").addClass("yellow"),h.show()):
(a("#save-menu-block input.button").removeClass("yellow"),h.hide())};a("#p-content").on("change.photos-save-menu","#photo-list.p-descriptions :text, #photo-list.p-descriptions textarea",c);a("#p-content").on("keyup.photos-save-menu","#photo-list.p-descriptions :text, #photo-list.p-descriptions textarea",c)}});a.photos.menu.register("list","#selector-menu",{selectPhotosAction:function(c){var e=a("#share-menu-block, #organize-menu-block").find(".count");c.data("checked")?(c.data("checked",!1),c.find(".unchecked").show().end().find(".checked").hide(),
e.text("").hide()):(c.data("checked",!0),c.find(".checked").show().end().find(".unchecked").hide(),e.text(a.photos.total_count).show());a("#photo-list li").trigger("select",[!!c.data("checked"),!1])}});a("#p-sidebar a, #wa-header a, #js-photos-view-toggle button, #photo-list div.p-image a").on("click",function(c){if(a("#save-menu-block").is(":visible")&&a("#save-menu-block input.button").hasClass("yellow")&&!confirm($_("Unsaved changes will be lost if you leave this page now. Are you sure?")))return c.preventDefault(),
!1})})(jQuery);(function(a){a.photos.menu.register("photo","#photo-organize-menu",{addToAlbumAction:function(){a.photos.confirmDialog({url:"?module=dialog&action=albums&id="+a.photos.getPhotoId(),onSubmit:function(c){var e=a.photos.photo_stream_cache.getCurrent().id;a.photos.addToAlbums({photo_id:e,album_id:a(this).serializeArray(),copy:0,fn:function(g){if("ok"==g.status){var h=g.data.old_albums||[],b=a.photos.getAlbum();g=g.data.albums;if(b)for(var d=0,f=h.length;d<f;++d)if(b.id==h[d].id){g.length?a.photos.goToHash("/album/"+
g[0].id+"/photo/"+e):a.photos.goToHash("/photo/"+e);c.trigger("close");return}a("#photo-albums").html(tmpl("template-photo-albums",{albums:g}));c.trigger("close")}}});return!1}})},deletePhotoAction:function(){a.photos.confirmDialog({url:"?module=dialog&action=confirmDeletePhoto&id="+a.photos.getPhotoId(),onSubmit:function(c){c.trigger("close");a.photos.setCover();a.photos.deletePhotos(a.photos.getPhotoId(),function(){a.photos.unsetCover()});return!1}})},unstackAction:function(){a.photos.confirmDialog({url:"?module=dialog&action=confirmUnstack&cnt="+
a.photos.photo_stack_cache.length(),onSubmit:function(c){c.trigger("close");c=a.photos.photo_stream_cache.getCurrent().id;a.post("?module=stack&action=unmake&id="+c,{},function(c){a.photos.goToHash(a.photos.hash)},"json");return!1}})},manageAccessAction:function(){var c=a.photos.photo_stream_cache.getCurrent().id;a.photos.showManageAccessDialog("photo_id="+c,function(c){var e=a(this).serializeArray();e.push({name:"one_photo",value:1});a.photos.saveAccess({photo_id:a.photos.photo_stream_cache.getCurrent().id,
data:e,fn:function(e){var b=e.data.photo,d=e.data.stack;if(b)b=a.photos.photo_stream_cache.updateById(b.id,b),a.photos.initPhotoContentControlWidget({frontend_link_template:e.data.frontend_link_template,photo:b}),a.photos.updatePhotoImgs(b);else if(d&&a.isArray(d)&&d.length){for(var b=a.photos.photo_stack_cache,f=b.getCurrent(),g=0,h=d.length;g<h;++g)b.updateById(d[g].id,d[g]);a.photos.initPhotoContentControlWidget({frontend_link_template:e.data.frontend_link_template,photo:f});a.photos.updatePhotoImgs(f)}c.trigger("close")},
onDeniedExist:function(){alert($_("You don't have sufficient access rights"))}});return!1});return!1}});a.photos.menu.register("photo","#edit-menu",{beforeAnyAction:function(){a.photos.setCover()},rotateLeftAction:function(){a.photos.rotate(a.photos.getPhotoId(),"left",function(){a.photos.unsetCover()})},rotateRightAction:function(){a.photos.rotate(a.photos.getPhotoId(),"right",function(){a.photos.unsetCover()})},onInit:function(){a(window).resize(a.photos.centralizeLoadingIcon)}});a.photos.menu.register("photo",
"#share-menu",{embedAction:function(){var c=a("#embed-photo-dialog"),e=a.photos.getPhotoId(),g=a.photos.hash,h=a.storage.get("photos/embed_size"),e="?module=dialog&action=embedPhoto&photo_id="+e+"&hash="+g;h&&(e+="&size="+h);c.length||(c=a('<div id="embed-photo-dialog"></div>'),a("body").append(c));c.load(e,function(){c.find("div:first").waDialog({onLoad:function(){function b(){g.length&&a.each(["textarea[name=html]","input[name=url]"],function(b,c){var d=a(c);d.data("context_data",d.val())})}function d(){if(!g.length)return!1;
a.each(["textarea[name=html]","input[name=url]"],function(b,c){var d=a(c);d.val(d.data("context_data").split(g.data("original-domain")).join(g.val()))});var b=g.children(":selected");b.data("frontend-url")?(c.find("input[name=link]").val(b.data("frontend-url")).closest(".field").slideDown(),c.find("a.link").attr("href",b.data("frontend-url"))):c.find("input[name=link]").closest(".field").slideUp()}var e=c.find("select[name=size]");e.val(h);e.change(function(){var e=a(this).val(),f=c.data("contexts")[e];
c.find("textarea[name=html]").val(f.html);c.find("input[name=url]").val(f.url);a.storage.set("photos/embed_size",e);b();d()});var g=c.find("select[name=domain]");g.length&&(b(),d(),g.change(d));c.find("input[name=url], textarea[name=html], input[name=link]").click(function(){a(this).getSelection().length||a(this).select()});c.find("input[name=link]").focus().select()},onSubmit:function(){return!1}})});return!1},blogPostAction:function(){var c=a("#blog-post-form"),e=a.photos.getPhotoId(),g=a.photos.photo_stream_cache.getById(e);
g||(g=a.photos.photo_stack_cache.getById(e));g&&(e=g.id,g.hash&&(e+=":"+g.hash),e={photo_ids:e,hash:null,size:obligatory_size},a("#photo-blog-dialog :submit").attr("disabled",!0),a.post("?module=photo&action=embedList",e,function(e){"ok"==e.status&&(e=e.data.context,c.find('[name="title"]:input').val(g.name),e=e.html_with_descriptions,c.find('[name="text"]:input').val(e.replace(/^<p>(.*)<\/p>$/mi,"$1")),parseInt(g.status)?c.submit():a("#photo-blog-dialog :submit").attr("disabled",!1))},"json"),parseInt(g.status)||
a("#photo-blog-dialog").waDialog({onLoad:function(){a("#photo-blog-dialog :submit").attr("disabled",!0);var c=a("#photo-blog-dialog p"),b=[1,1];c.html(c.html().replace(/(%d)/g,function(){return b.shift()}))},onSubmit:function(){c.submit();return!1}}));return!1}});a("#restore-original").on("click",function(){confirm($_("This will reset all changes you applied to the image after upload, and will restore the image to its original. Are you sure?"))&&(a.photos.setCover(),a.photos.restoreOriginal(a.photos.getPhotoId(),
function(){a.photos.unsetCover()}))})})(jQuery);$.photos=$.photos||{};$.photos.widget=$.photos.widget||{};
$.photos.widget.loupe={options:{animate:!0,debug:!1},css:{init:{width:null,"max-width":null,"margin-left":0,"margin-top":0,height:null}},drag:!1,loaded:!1,photo_data:null,thumb_data:null,container:null,helper:null,link:null,offset:{},status:"thumb",image_container_width:0,image_container_height:0,image_width:0,image_height:0,init:function(a){this.options=$.extend(this.options,a||{});var c=this;c.trace("init");$.photos.hooks_manager.bind("afterRenderImg",function(a,g,h){c.trace("afterRenderImg");c.prepare(a,
g,h)});$.photos.hooks_manager.bind("beforeLoadPhoto",function(){c.trace("beforeLoadPhoto")});$.photos.hooks_manager.bind("onAbortPrevLoading",function(){c.trace("onAbortPrevLoading")})},trace:function(a){console&&this.options.debug&&console.log(a)},prepare:function(a,c,e){var g=this;$(".p-one-photo a.next").die("click.loupe").live("click.loupe",function(a){return g.clickNextHandler.apply(g,[this,a])});this.trace("prepare, status="+this.status);this.photo_data=c;this.container=a;a=this.container.closest(".p-one-photo");
this.image_container_width=a.width();this.image_container_height=a.height();this.image_width=this.container.width();this.image_height=this.container.height();this.thumb_data={height:this.image_height,width:this.image_width,src:e.url2x};c.height>=this.image_container_height?this.container.css({width:this.image_width+"px",height:this.image_height+"px"}):this.container.css({width:e.size.width+"px",height:e.size.height+"px"});window.addEventListener("resize",function(){var a=g.container.closest(".p-one-photo");
g.image_container_width=a.width();g.image_container_height=a.height();g.image_width=g.container.width();g.image_height=g.container.height();g.thumb_data={height:g.image_height,width:g.image_width,src:e.url2x};c.height>=g.image_container_height?g.container.css({width:g.image_width+"px",height:g.image_height+"px"}):g.container.css({width:e.size.width+"px",height:e.size.height+"px"})});"thumb"!=this.status&&this.stop();this.loaded=!1;this.reset()},reset:function(){var a=this;this.trace("reset, status="+
this.status);this.link=$("#photo-loupe-link");$("div.photo-loupe-wrapper").length&&(this.container.css({width:this.image_width+"px","max-width":"",height:this.image_height+"px","margin-left":"","margin-top":""}),this.container.unwrap());this.status="thumb";this.link.find(".minimize").hide();this.image_container_width&&this.image_container_width<this.photo_data.width||this.image_container_height&&this.image_container_height<this.photo_data.height?(this.link.find(".maximize").show(),this.options.animate=
this.image_container_height&&this.image_container_width?!0:!1):this.link.find(".maximize").hide();this.link.unbind(".loupe").bind("click.loupe",function(c){return a.clickHandler.apply(a,[this,c])}).show();window.addEventListener("resize",function(){a.image_container_width&&a.image_container_width<a.photo_data.width||a.image_container_height&&a.image_container_height<a.photo_data.height?(a.link.find(".maximize").show(),a.options.animate=a.image_container_height&&a.image_container_width?!0:!1):a.link.find(".maximize").hide();
a.link.unbind(".loupe").bind("click.loupe",function(c){return a.clickHandler.apply(a,[this,c])}).show()})},clickHandler:function(){this.trace("clickHandler, status="+this.status);switch(this.status){case "loading":this.container.stop();case "maximized":this.status="unloading";this.link.find(".minimize").hide();this.link.find(".maximize").show();this.decrease();break;case "thumb":this.status="loading",this.link.find(".minimize").hide(),this.link.find(".maximize").hide(),this.enlarge()}return!1},clickNextHandler:function(a,
c){var e="thumb"==this.status?!0:!1;e||c.preventDefault();this.trace("clickNextHandler "+e);return e},interaction:function(a,c,e){e=e.parents("body");switch(c.type){case "mouseup":this.drag&&(c.preventDefault(),this.drag=!1,$("div.photo-loupe-wrapper").css("cursor","auto"),$("body").css("cursor",""),e.unbind(".loupe-move"));break;case "mousedown":case "click":this.clickNextHandler(a,c);if(!this.drag){$("div.photo-loupe-wrapper").css("cursor","move");this.drag=!0;this.offset.mouseX=c.pageX;this.offset.mouseY=
c.pageY;var g=this;e.bind("mouseover.loupe-move mousemove.loupe-move",function(a){return g.watch.apply(g,[this,a])})}break;case "mouseleave":this.drag&&(c.preventDefault(),$("div.photo-loupe-wrapper").css("cursor","auto"),this.drag=!1,e.unbind(".loupe-move"))}},enlarge:function(){this.drag=!1;var a=this;this.trace("enlarge, status="+this.status);$("#photo").removeClass("ui-draggable").closest(".p-image").addClass("p-image-maximized");this.offset=this.container.offset();this.offset.x=Math.round((this.image_container_width-
this.photo_data.width)/2);this.offset.y=Math.round((this.image_container_height-this.photo_data.height)/2);this.container.wrap('<div class="photo-loupe-wrapper" style="height:'+this.image_container_height+"px;width:"+this.image_container_width+'px;position: relative;"/>');window.addEventListener("resize",function(){this.offset=this.container.offset();this.offset.x=Math.round((this.image_container_width-this.photo_data.width)/2);this.offset.y=Math.round((this.image_container_height-this.photo_data.height)/
2);this.container.wrap('<div class="photo-loupe-wrapper" style="height:'+this.image_container_height+"px;width:"+this.image_container_width+'px;position: relative;"/>')});this.container.removeAttr("width").removeAttr("height").css({width:this.image_width+"px",height:this.image_height+"px","margin-left":0,"margin-top":0,"max-height":this.photo_data.height+"px","max-width":this.photo_data.width+"px",display:"inline-block"});this.options.animate=!0;this.options.animate?this.container.animate({width:this.photo_data.width+
"px",height:this.photo_data.height+"px","margin-left":this.offset.x+"px","margin-top":this.offset.y+"px","max-height":this.photo_data.height+"px","max-width":this.photo_data.width+"px"},function(){a.enlargeComplete.apply(a,[this])}):(this.container.css({width:this.photo_data.width+"px",height:this.photo_data.height+"px","margin-left":this.offset.x+"px","margin-top":this.offset.y+"px","max-width":this.photo_data.width+"px"}),this.enlargeComplete());this.link.find(".minimize").show();this.bind(this.container);
if(!this.helper){var c=$("#photo-loupe");this.helper=c.length?c.first():$('<img id="photo-loupe"/>');this.helper.load(function(c){a.loaded=!0})}this.helper.attr("src","?module=photo&action=download&photo_id="+this.photo_data.id+"&attach="+(this.photo_data.edit_datetime||this.photo_data.upload_datetime))},enlargeComplete:function(){if(this.loaded)this.trace("enlargeComplete, status="+this.status),this.helper.css({width:this.photo_data.width+"px",height:this.photo_data.height+"px","margin-left":this.offset.x+
"px","margin-top":this.offset.y+"px","max-width":this.photo_data.width+"px"}).show(),this.container.before(this.helper).hide(),this.container.unbind(".loupe .loupe-move"),this.bind(this.helper),this.container.css({width:this.thumb_data.width+"px","max-width":"",height:this.thumb_data.height+"px","margin-left":"","margin-top":""}),this.link.find(".minimize").show(),this.status="maximized";else{var a=this;setTimeout(function(){return a.enlargeComplete.apply(a,[this])},50)}},bind:function(a){this.trace("bind, status="+
this.status);var c=this;a.bind("mousedown.loupe",function(e){return c.interaction.apply(c,[this,e,a])});$(document).bind("mouseup.loupe",function(e){return c.interaction.apply(c,[this,e,a])})},stop:function(){this.trace("stop at status="+this.status);var a=this.status;this.status="stop";switch(a){case "loading":this.container.stop();this.decrease(!0);break;case "maximized":this.decrease(!0);break;case "unloading":this.helper&&this.helper.stop(),this.decreaseComplete(!0)}this.container&&this.container.find("*").unbind(".loupe .loupe-move");
$(document).unbind(".loupe .loupe-move");a=$("div.photo-loupe-wrapper");$("#photo-loupe-link img:visible").hide();$("body").css("cursor","");a.length&&this.container.unwrap();this.helper&&(this.helper.remove(),this.helper=null);this.status="thumb"},decrease:function(a){this.trace("decrease, status="+this.status);this.loaded=!1;var c=this,e=this.photo_data.height>=this.image_container_height?{width:this.image_width+"px",height:this.image_height+"px","margin-left":0,"margin-top":0}:{width:this.thumb_data.width+
"px",height:this.thumb_data.height+"px","margin-left":0,"margin-top":0};a||!this.options.animate?(this.helper.css(e),c.decreaseComplete()):this.helper.animate(e,function(){c.decreaseComplete()});return!1},decreaseComplete:function(a){this.trace("decreaseComplete, status="+this.status);$("#photo").addClass("ui-draggable").closest(".p-image").removeClass("p-image-maximized");this.container.css(this.css.init).show();this.helper.hide();a||this.reset()},watch:function(a,c){this.drag&&(c.preventDefault(),
this.offset.x=Math.min(0,Math.max(this.image_width-this.photo_data.width,Math.round(this.offset.x-this.offset.mouseX+c.pageX))),this.offset.y=Math.min(0,Math.max(this.image_height-this.photo_data.height,Math.round(this.offset.y-this.offset.mouseY+c.pageY))),this.offset.mouseX=c.pageX,this.offset.mouseY=c.pageY,("loading"==this.status?this.container:this.helper).css({"margin-left":this.offset.x+"px","margin-top":this.offset.y+"px"}))}};(function(){jQuery.each({getSelection:function(){var a=this.jquery?this[0]:this;return("selectionStart"in a&&function(){var c=a.selectionEnd-a.selectionStart;return{start:a.selectionStart,end:a.selectionEnd,length:c,text:a.value.substr(a.selectionStart,c)}}||document.selection&&function(){a.focus();var c=document.selection.createRange();if(null===c)return{start:0,end:a.value.length,length:0};var e=a.createTextRange(),g=e.duplicate();e.moveToBookmark(c.getBookmark());g.setEndPoint("EndToStart",e);
return{start:g.text.length,end:g.text.length+c.text.length,length:c.text.length,text:c.text}}||function(){return null})()},replaceSelection:function(a){var c="function"==typeof this.id?this.get(0):this,e=a||"";return("selectionStart"in c&&function(){c.value=c.value.substr(0,c.selectionStart)+e+c.value.substr(c.selectionEnd,c.value.length);return this}||document.selection&&function(){c.focus();document.selection.createRange().text=e;return this}||function(){c.value+=e;return jQuery(c)})()}},function(a){jQuery.fn[a]=
this})})();
